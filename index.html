<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' data: blob:; font-src 'self'; connect-src 'self'; object-src 'none'; base-uri 'none'; form-action 'none'; frame-ancestors 'none';">
  <title>Eterna</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; width: 100%; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; overflow: hidden; }
    #app { height: 100%; width: 100%; display: flex; flex-direction: column; overflow: hidden; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { border-radius: 3px; }
    input:focus, textarea:focus, select:focus { outline: none; }
    button { font-family: inherit; transition: all 0.2s ease; }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0) scale(0.98); }
    .drag-over { background: rgba(183, 148, 244, 0.2) !important; border-style: dashed !important; }
    .dragging { opacity: 0.5; }
    .totp-code { font-family: monospace; font-size: 28px; letter-spacing: 4px; font-weight: 600; }
    .totp-timer { width: 100%; height: 4px; border-radius: 2px; margin-top: 8px; transition: width 1s linear; }
    .context-menu { position: fixed; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 6px 0; min-width: 160px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000; animation: fadeIn 0.15s ease; }
    .context-menu-item { padding: 8px 14px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 10px; transition: background 0.15s; }
    .context-menu-item:hover { background: var(--accent-bg); }
    .context-menu-divider { height: 1px; background: var(--border); margin: 6px 0; }
    .save-indicator { position: fixed; bottom: 20px; right: 20px; padding: 10px 16px; border-radius: 8px; font-size: 13px; z-index: 500; transition: opacity 0.3s, transform 0.3s; animation: slideUp 0.3s ease; }
    .folder-drop-zone { transition: all 0.2s; }
    .folder-drop-zone.drag-over { background: rgba(183, 148, 244, 0.3) !important; transform: scale(1.02); }
    .list-item { transition: all 0.2s ease; }
    .list-item:hover { transform: translateX(4px); }
    .titlebar { -webkit-app-region: drag; }
    .titlebar button, .titlebar .nav-btn { -webkit-app-region: no-drag; }
    .window-controls { display: flex; gap: 8px; -webkit-app-region: no-drag; }
    .window-control-btn { width: 36px; height: 28px; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.15s; }
    .window-control-btn:hover { transform: none; }
    .window-control-btn.minimize:hover { background: rgba(255,255,255,0.1); }
    .window-control-btn.maximize:hover { background: rgba(255,255,255,0.1); }
    .window-control-btn.close:hover { background: #e81123; }
    .window-control-btn.close:hover svg { fill: white; }

    /* Loading spinner */
    .spinner { width: 20px; height: 20px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.8s linear infinite; }
    .spinner-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .spinner-large { width: 40px; height: 40px; border-width: 3px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Error state */
    .error-banner { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); padding: 12px 20px; background: #dc3545; color: white; border-radius: 8px; z-index: 1000; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

    /* Context menu enhancements */
    .context-menu { min-width: 180px; }
    .context-menu-item { padding: 10px 16px; }
    .context-menu-item svg { width: 14px; height: 14px; opacity: 0.7; }
    .context-menu-item.danger { color: #dc3545; }
    .context-menu-item.danger:hover { background: rgba(220, 53, 69, 0.1); }

    /* Favicon */
    .favicon { width: 32px; height: 32px; border-radius: 6px; object-fit: contain; background: rgba(255,255,255,0.1); }
    .favicon-placeholder { width: 32px; height: 32px; border-radius: 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 13px; color: white; font-weight: 600; text-transform: uppercase; }

    /* Toast notifications */
    .toast-container { position: fixed; top: 48px; right: 16px; z-index: 10000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
    .toast { padding: 12px 16px; border-radius: 10px; display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 500; box-shadow: 0 4px 20px rgba(0,0,0,0.25); pointer-events: auto; animation: toastIn 0.3s ease; min-width: 200px; max-width: 320px; backdrop-filter: blur(10px); }
    .toast.success { background: linear-gradient(135deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95)); color: white; }
    .toast.error { background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95)); color: white; }
    .toast.warning { background: linear-gradient(135deg, rgba(245, 158, 11, 0.95), rgba(217, 119, 6, 0.95)); color: white; }
    .toast.info { background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95)); color: white; }
    .toast-icon { font-size: 16px; flex-shrink: 0; }
    .toast-message { flex: 1; }
    .toast-close { cursor: pointer; opacity: 0.7; transition: opacity 0.15s; padding: 4px; margin: -4px; }
    .toast-close:hover { opacity: 1; }
    @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes toastOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

    /* Password strength meter */
    .strength-meter { height: 4px; border-radius: 2px; margin-top: 8px; background: var(--border); overflow: hidden; }
    .strength-meter-fill { height: 100%; transition: width 0.3s, background 0.3s; border-radius: 2px; }
    .strength-meter-fill.weak { width: 25%; background: #ef4444; }
    .strength-meter-fill.fair { width: 50%; background: #f59e0b; }
    .strength-meter-fill.good { width: 75%; background: #3b82f6; }
    .strength-meter-fill.strong { width: 100%; background: #22c55e; }
    .strength-label { font-size: 11px; margin-top: 4px; font-weight: 500; }
    .strength-label.weak { color: #ef4444; }
    .strength-label.fair { color: #f59e0b; }
    .strength-label.good { color: #3b82f6; }
    .strength-label.strong { color: #22c55e; }

    /* Quick copy button */
    .quick-copy { opacity: 0; transition: opacity 0.15s; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 11px; background: var(--accent); color: white; }
    .list-item:hover .quick-copy { opacity: 1; }
    
    /* Item badges */
    .item-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-left: 6px; }
    .item-badge.weak { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .item-badge.duplicate { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

    /* Search enhancements */
    .search-container { position: relative; }
    .search-filter-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: 4px 8px; background: var(--surfaceAlt); border: 1px solid var(--border); border-radius: 4px; font-size: 11px; cursor: pointer; color: var(--textMuted); }
    .search-filter-btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
    .search-highlight { background: rgba(250, 204, 21, 0.4); padding: 1px 2px; border-radius: 2px; }
    .search-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 8px; margin-top: 4px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .search-dropdown label { display: flex; align-items: center; gap: 8px; padding: 6px 8px; font-size: 12px; cursor: pointer; border-radius: 4px; }
    .search-dropdown label:hover { background: var(--accent-bg); }

    /* Keyboard shortcut hints */
    .shortcut-hint { font-size: 11px; color: inherit; opacity: 0.5; margin-left: auto; font-family: monospace; }
    .nav-btn { transition: all 0.2s ease; }
    .nav-btn:hover { transform: translateY(-1px); }
    .modal-overlay { animation: fadeIn 0.2s ease; }
    .modal-content { animation: slideUp 0.25s ease; }
    input, textarea { transition: border-color 0.2s ease, box-shadow 0.2s ease; }
    input:focus, textarea:focus { box-shadow: 0 0 0 3px rgba(183, 148, 244, 0.15); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .totp-countdown { animation: pulse 1s ease infinite; }
    .online-indicator { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 500; }
    .online-indicator.online { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .online-indicator.offline { background: rgba(239, 68, 68, 0.15); color: #ef4444; animation: pulse 2s ease infinite; }
    .online-dot { width: 8px; height: 8px; border-radius: 50%; }
    .online-dot.online { background: #22c55e; }
    .online-dot.offline { background: #ef4444; }
    .confirm-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 300; animation: fadeIn 0.15s ease; }
    .confirm-dialog { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; animation: slideUp 0.2s ease; }
    .confirm-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .confirm-message { font-size: 14px; color: var(--text-muted); margin-bottom: 24px; line-height: 1.5; }
    .confirm-buttons { display: flex; gap: 12px; justify-content: flex-end; }
    .confirm-btn { padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .confirm-btn.cancel { background: var(--elevated); border: 1px solid var(--border); color: var(--text); }
    .confirm-btn.danger { background: #ef4444; border: none; color: #fff; }
    .confirm-btn.primary { background: var(--accent); border: none; color: #fff; }
  </style>
  <script src="jsqr.min.js"></script>
</head>
<body>
  <div id="app"></div>

  <script>
    const STORAGE_KEY = 'eterna-v2';

    // ============ TOTP UTILITIES ============
    const TOTP = {
      base32Chars: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567',

      base32Decode(str) {
        // Limit input length to prevent memory exhaustion (max 1024 chars = 640 bytes decoded)
        const MAX_INPUT_LENGTH = 1024;
        str = str.toUpperCase().replace(/[^A-Z2-7]/g, '').substring(0, MAX_INPUT_LENGTH);
        if (str.length === 0) {
          return new Uint8Array(0);
        }
        let bits = '';
        for (const c of str) {
          const val = this.base32Chars.indexOf(c);
          if (val === -1) continue;
          bits += val.toString(2).padStart(5, '0');
        }
        const bytes = [];
        for (let i = 0; i + 8 <= bits.length; i += 8) {
          bytes.push(parseInt(bits.substring(i, i + 8), 2));
        }
        return new Uint8Array(bytes);
      },

      async hmacSha1(key, message) {
        const cryptoKey = await window.crypto.subtle.importKey(
          'raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']
        );
        const sig = await window.crypto.subtle.sign('HMAC', cryptoKey, message);
        return new Uint8Array(sig);
      },

      async generate(secret, timeStep = 30, digits = 6) {
        try {
          const key = this.base32Decode(secret);
          let time = Math.floor(Date.now() / 1000 / timeStep);
          const timeBytes = new Uint8Array(8);
          for (let i = 7; i >= 0; i--) {
            timeBytes[i] = time & 0xff;
            time >>= 8;
          }
          const hmac = await this.hmacSha1(key, timeBytes);
          const offset = hmac[hmac.length - 1] & 0x0f;
          // RFC 4226: ensure we have 4 bytes available from offset
          if (offset + 4 > hmac.length) {
            throw new Error('Invalid HMAC offset');
          }
          // Use >>> 0 to force unsigned 32-bit integer (RFC 4226 compliance)
          const binary = (((hmac[offset] & 0x7f) << 24) |
                        ((hmac[offset + 1] & 0xff) << 16) |
                        ((hmac[offset + 2] & 0xff) << 8) |
                        (hmac[offset + 3] & 0xff)) >>> 0;
          const otp = binary % Math.pow(10, digits);
          return otp.toString().padStart(digits, '0');
        } catch (e) {
          // Return error indicator instead of silently failing
          console.error('TOTP generation failed:', e.message);
          return '------'; // Visual indicator of error
        }
      },

      getTimeRemaining(timeStep = 30) {
        return timeStep - (Math.floor(Date.now() / 1000) % timeStep);
      },

      parseOtpAuthUri(uri) {
        try {
          if (!uri.startsWith('otpauth://totp/')) return null;
          const url = new URL(uri);
          const label = decodeURIComponent(url.pathname.slice(6));
          const secret = url.searchParams.get('secret');
          const issuer = url.searchParams.get('issuer') || label.split(':')[0];
          const account = label.includes(':') ? label.split(':')[1] : label;
          return { secret, issuer, account };
        } catch (e) {
          console.error('Failed to parse otpauth URI:', e);
          return null;
        }
      }
    };

    // ============ QR CODE SCANNER ============
    const QRScanner = {
      async scanFromImage(imageData) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = this.decodeQR(imgData);
            resolve(code);
          };
          img.onerror = () => resolve(null);
          img.src = imageData;
        });
      },

      decodeQR(imageData) {
        if (typeof jsQR !== 'undefined') {
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          return code ? code.data : null;
        }
        return null;
      },

      async scanFromCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          return {
            stream,
            stop: () => stream.getTracks().forEach(t => t.stop())
          };
        } catch (err) {
          // Handle permission denied or no camera available
          const message = err.name === 'NotAllowedError'
            ? 'Camera permission denied'
            : err.name === 'NotFoundError'
              ? 'No camera found'
              : 'Failed to access camera';
          throw new Error(message);
        }
      }
    };

    // ============ THEMES ============
    const themes = {
      moonlight: {
        name: 'Moonlight',
        bg: 'linear-gradient(165deg, #0a0a14 0%, #12101f 40%, #1a1528 70%, #0f0d18 100%)',
        surface: 'rgba(18, 16, 32, 0.95)',
        surfaceAlt: 'rgba(26, 22, 45, 0.9)',
        elevated: 'rgba(35, 30, 58, 0.95)',
        border: 'rgba(147, 112, 219, 0.15)',
        text: '#e8e4f4',
        textMuted: '#a89ec8',
        textFaint: '#6a6288',
        accent: '#b794f4',
        accentHover: '#d4b8ff',
        accentGlow: 'rgba(183, 148, 244, 0.4)',
        danger: '#f0a0a0',
        success: '#90dbb0',
        warning: '#f0d080'
      },
      aurora: {
        name: 'Aurora',
        bg: 'linear-gradient(165deg, #0c1220 0%, #162038 40%, #1a2848 70%, #101828 100%)',
        surface: 'rgba(16, 24, 40, 0.95)',
        surfaceAlt: 'rgba(22, 32, 56, 0.9)',
        elevated: 'rgba(30, 42, 68, 0.95)',
        border: 'rgba(100, 180, 255, 0.12)',
        text: '#e4eef8',
        textMuted: '#8ab4d8',
        textFaint: '#5a7898',
        accent: '#70b8ff',
        accentHover: '#98ccff',
        accentGlow: 'rgba(100, 180, 255, 0.4)',
        danger: '#f0a0a0',
        success: '#90dbb0',
        warning: '#f0d080'
      },
      rosewood: {
        name: 'Rosewood',
        bg: 'linear-gradient(165deg, #140a12 0%, #241420 40%, #2e1828 70%, #180e14 100%)',
        surface: 'rgba(28, 16, 24, 0.95)',
        surfaceAlt: 'rgba(40, 24, 35, 0.9)',
        elevated: 'rgba(52, 32, 45, 0.95)',
        border: 'rgba(255, 140, 180, 0.12)',
        text: '#f4e8f0',
        textMuted: '#d0a0b8',
        textFaint: '#906878',
        accent: '#ff8fb8',
        accentHover: '#ffb0d0',
        accentGlow: 'rgba(255, 140, 180, 0.4)',
        danger: '#f0a0a0',
        success: '#90dbb0',
        warning: '#f0d080'
      },
      twilight: {
        name: 'Twilight',
        bg: 'linear-gradient(165deg, #100e14 0%, #18151e 40%, #1f1b28 70%, #100e14 100%)',
        surface: 'rgba(24, 21, 30, 0.95)',
        surfaceAlt: 'rgba(31, 27, 40, 0.9)',
        elevated: 'rgba(40, 35, 50, 0.95)',
        border: 'rgba(196, 181, 253, 0.12)',
        text: '#ece8f2',
        textMuted: '#a898b8',
        textFaint: '#706080',
        accent: '#b8a4e8',
        accentHover: '#c8b8f0',
        accentGlow: 'rgba(184, 164, 232, 0.4)',
        danger: '#f0a0a0',
        success: '#90dbb0',
        warning: '#f0d080'
      },
      mist: {
        name: 'Morning Mist',
        bg: 'linear-gradient(165deg, #f8f4e8 0%, #efe8d8 40%, #e8e0d0 70%, #f0ece0 100%)',
        surface: 'rgba(255, 252, 245, 0.98)',
        surfaceAlt: 'rgba(248, 244, 235, 0.95)',
        elevated: 'rgba(240, 235, 225, 0.98)',
        border: 'rgba(120, 100, 70, 0.15)',
        text: '#3a3428',
        textMuted: '#6a6050',
        textFaint: '#9a9080',
        accent: '#8b7355',
        accentHover: '#a08868',
        accentGlow: 'rgba(139, 115, 85, 0.3)',
        danger: '#a06050',
        success: '#608050',
        warning: '#a08040'
      },
      cosmos: {
        name: 'Cosmos',
        bg: 'linear-gradient(165deg, #050508 0%, #0a0810 40%, #0e0a18 70%, #060508 100%)',
        surface: 'rgba(10, 8, 18, 0.98)',
        surfaceAlt: 'rgba(16, 12, 28, 0.95)',
        elevated: 'rgba(22, 18, 38, 0.98)',
        border: 'rgba(130, 100, 200, 0.1)',
        text: '#e0dcea',
        textMuted: '#9088b0',
        textFaint: '#585070',
        accent: '#9580d0',
        accentHover: '#b0a0e0',
        accentGlow: 'rgba(130, 100, 200, 0.5)',
        danger: '#d08080',
        success: '#80c0a0',
        warning: '#c0a060'
      }
    };

    const fileIcons = {
      image: { icon: '', color: '#70b8ff' },
      pdf: { icon: '', color: '#f07070' },
      document: { icon: '', color: '#70b8ff' },
      spreadsheet: { icon: 'XLS', color: '#70c090' },
      video: { icon: 'VID', color: '#d070d0' },
      audio: { icon: 'AUD', color: '#f0a070' },
      archive: { icon: 'ZIP', color: '#a0a0a0' },
      code: { icon: 'COD', color: '#80d0d0' },
      text: { icon: 'TXT', color: '#a0a0a0' },
      default: { icon: 'FILE', color: '#808080' }
    };

    const templates = [
      { id: 'blank', name: 'Blank', icon: '', content: '' },
      { id: 'daily', name: 'Daily Log', icon: 'D', content: `# Daily Log - ${new Date().toLocaleDateString()}\n\n## Today's Goals\n- \n- \n- \n\n## Notes\n\n\n## Reflection\n\n` },
      { id: 'meeting', name: 'Meeting Notes', icon: 'M', content: `# Meeting Notes\n\n**Date:** ${new Date().toLocaleDateString()}\n**Attendees:** \n**Topic:** \n\n## Agenda\n1. \n2. \n3. \n\n## Discussion\n\n\n## Action Items\n- [ ] \n- [ ] \n\n## Next Steps\n\n` },
      { id: 'project', name: 'Project Plan', icon: 'P', content: `# Project: [Name]\n\n## Overview\n\n\n## Goals\n- \n- \n\n## Timeline\n| Phase | Start | End | Status |\n|-------|-------|-----|--------|\n| Planning | | | |\n| Development | | | |\n| Testing | | | |\n| Launch | | | |\n\n## Resources\n\n\n## Risks\n\n\n## Notes\n\n` },
      { id: 'journal', name: 'Journal Entry', icon: 'J', content: `# ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n\n## How I'm Feeling\n\n\n## What Happened Today\n\n\n## Gratitude\n1. \n2. \n3. \n\n## Tomorrow's Intentions\n\n` },
      { id: 'todo', name: 'To-Do List', icon: 'T', content: `# To-Do List\n\n## High Priority\n- [ ] \n- [ ] \n\n## Medium Priority\n- [ ] \n- [ ] \n\n## Low Priority\n- [ ] \n- [ ] \n\n## Completed\n- [x] \n` }
    ];

    const defaultData = {
      masterPasswordHash: null,
      journal: [],
      passwords: [],
      totp: [],
      notes: [],
      noteFolders: [],
      privatePasswordHash: null,
      files: [],
      trash: [],
      fileLinks: [],
      journalFolders: [],
      passwordFolders: [],
      fileFolders: [],
      settings: {
        theme: 'mist',
        fontSize: 14,
        encryptFiles: true,
        enableVersioning: true,
        autoLockMinutes: 5,
        maxLoginAttempts: 5,
        clearClipboard: true,
        clipboardTimeout: 30,
        defaultSection: 'journal',
        compactView: false,
        showPasswordStrength: true,
        confirmDelete: true,
        sortOrder: 'newest',
        maxFileSizeMB: 50,
        maxVaultSizeMB: 500,
        autoUpdate: false
      }
    };

    // ============ STATE ============
    let state = {
      data: { ...defaultData },
      locked: true,
      masterKey: '',
      setupMode: false,
      loaded: false,
      section: 'journal',
      search: '',
      selectedId: null,
      selectedFolder: null,
      editMode: 'write',
      showTrash: false,
      genLen: 20,
      genOpts: { lower: true, upper: true, numbers: true, symbols: true },
      genResult: '',
      showGen: false,
      showPass: {},
      dragOver: false,
      selectedFiles: [],
      showModal: null,
      modalData: {},
      showVersions: false,
      showTemplates: false,
      totpCodes: {},
      totpTimers: {},
      draggedItem: null,
      dragOverItem: null,
      lastActivity: Date.now(),
      contextMenu: null,
      saveIndicator: null,
      showQrScanner: false,
      cameraStream: null,
      isOnline: navigator.onLine,
      confirmDialog: null,
      privateLocked: true,
      privateKey: '',
      failedAttempts: 0,
      lockoutUntil: 0,
      permanentlyLocked: false,
      lockoutLevel: null,
      undoStack: [],
      redoStack: [],
      isLoading: false,
      loadingMessage: '',
      maxHistorySize: 50,
      searchFilter: 'all', // all, today, week, month
      showSearchFilters: false,
      updateStatus: null,
      updateVersion: null,
      updatePercent: 0,
      appVersion: '2.0.2'
    };

    // ============ DOCUMENT LISTENER CLEANUP ============
    // Track document-level event listeners to prevent memory leaks
    const documentListeners = [];

    const addDocumentListener = (event, handler, options) => {
      document.addEventListener(event, handler, options);
      documentListeners.push({ event, handler, options });
    };

    const cleanupDocumentListeners = () => {
      while (documentListeners.length > 0) {
        const { event, handler, options } = documentListeners.pop();
        document.removeEventListener(event, handler, options);
      }
    };

    // ============ UTILITIES ============
    const generateId = () => {
      // Use crypto for better randomness, fallback to Math.random
      const randomPart = typeof crypto !== 'undefined' && crypto.randomUUID
        ? crypto.randomUUID().replace(/-/g, '').substring(0, 12)
        : Math.random().toString(36).substring(2, 14).padEnd(12, '0');
      return Date.now().toString(36) + randomPart;
    };

    const generatePassword = (len, opts) => {
      let chars = '';
      if (opts.lower) chars += 'abcdefghijklmnopqrstuvwxyz';
      if (opts.upper) chars += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      if (opts.numbers) chars += '0123456789';
      if (opts.symbols) chars += '!@#$%^&*_+-=?';
      if (!chars) chars = 'abcdefghijklmnopqrstuvwxyz';
      let result = '';
      const array = new Uint32Array(len);
      window.crypto.getRandomValues(array);
      for (let i = 0; i < len; i++) {
        result += chars[array[i] % chars.length];
      }
      return result;
    };

    // Secure memory clearing - overwrites sensitive data before releasing
    const secureClear = {
      // Clear a string by creating array buffer and zeroing it
      string: (str) => {
        if (!str) return '';
        const len = str.length;
        const arr = new Uint8Array(len);
        window.crypto.getRandomValues(arr); // Overwrite with random data
        return '';
      },
      // Clear an object's sensitive properties
      object: (obj, keys) => {
        if (!obj) return;
        keys.forEach(key => {
          if (typeof obj[key] === 'string') {
            obj[key] = secureClear.string(obj[key]);
          } else if (typeof obj[key] === 'object') {
            obj[key] = null;
          }
        });
      },
      // Clear all TOTP codes from memory
      totpCodes: (codes) => {
        if (!codes) return {};
        Object.keys(codes).forEach(key => {
          codes[key] = secureClear.string(codes[key]);
          delete codes[key];
        });
        return {};
      }
    };

    const formatDate = (ts) => {
      const d = new Date(ts);
      const now = new Date();
      const diff = now - d;
      if (diff < 60000) return 'just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    };

    const formatFullDate = (ts) => new Date(ts).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });

    const formatBytes = (b) => {
      // Ensure b is a valid positive number
      const num = typeof b === 'number' ? b : parseFloat(b);
      if (!Number.isFinite(num) || num < 0) return '0 B';
      if (num === 0) return '0 B';
      if (num < 1) return num.toFixed(2) + ' B'; // Handle fractional bytes
      const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
      const i = Math.min(Math.floor(Math.log(num) / Math.log(1024)), units.length - 1);
      return (num / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
    };

    const getFileType = (file) => {
      const type = file.type || '';
      const name = file.name || '';
      const parts = name.split('.');
      const ext = parts.length > 1 ? parts.pop().toLowerCase() : '';
      if (type.startsWith('image/')) return 'image';
      if (type === 'application/pdf' || ext === 'pdf') return 'pdf';
      if (type.startsWith('video/')) return 'video';
      if (type.startsWith('audio/')) return 'audio';
      if (['doc', 'docx', 'odt', 'rtf'].includes(ext)) return 'document';
      if (['xls', 'xlsx', 'csv', 'ods'].includes(ext)) return 'spreadsheet';
      if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) return 'archive';
      if (['js', 'jsx', 'ts', 'tsx', 'py', 'java', 'c', 'cpp', 'html', 'css', 'json', 'xml'].includes(ext)) return 'code';
      if (['txt', 'md', 'log'].includes(ext) || type.startsWith('text/')) return 'text';
      return 'default';
    };

    
    // ============ PASSWORD STRENGTH ============
    const calculatePasswordStrength = (password) => {
      if (!password) return { score: 0, label: 'None', class: '' };
      
      let score = 0;
      const checks = {
        length8: password.length >= 8,
        length12: password.length >= 12,
        length16: password.length >= 16,
        lowercase: /[a-z]/.test(password),
        uppercase: /[A-Z]/.test(password),
        numbers: /[0-9]/.test(password),
        symbols: /[^a-zA-Z0-9]/.test(password),
        noRepeats: !/(.){2,}/.test(password),
        noSequence: !/(?:abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|012|123|234|345|456|567|678|789)/i.test(password)
      };
      
      if (checks.length8) score += 1;
      if (checks.length12) score += 1;
      if (checks.length16) score += 1;
      if (checks.lowercase) score += 1;
      if (checks.uppercase) score += 1;
      if (checks.numbers) score += 1;
      if (checks.symbols) score += 2;
      if (checks.noRepeats) score += 1;
      if (checks.noSequence) score += 1;
      
      if (score <= 3) return { score, label: 'Weak', class: 'weak' };
      if (score <= 5) return { score, label: 'Fair', class: 'fair' };
      if (score <= 7) return { score, label: 'Good', class: 'good' };
      return { score, label: 'Strong', class: 'strong' };
    };

    const renderStrengthMeter = (password) => {
      const strength = calculatePasswordStrength(password);
      if (!password) return '';
      return `
        <div class="strength-meter"><div class="strength-meter-fill ${strength.class}"></div></div>
        <div class="strength-label ${strength.class}">${strength.label} password</div>
      `;
    };

    const checkDuplicatePassword = (password, excludeId = null) => {
      if (!password) return false;
      return state.data.passwords.some(p => p.id !== excludeId && p.password === password);
    };

    // ============ TEXT STATISTICS ============
    const getTextStats = (text) => {
      if (!text) return { words: 0, chars: 0, readingTime: 0 };
      const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
      const chars = text.length;
      const readingTime = Math.max(1, Math.ceil(words / 200)); // 200 wpm average
      return { words, chars, readingTime };
    };

    const formatReadingTime = (minutes) => {
      if (minutes < 1) return 'Less than 1 min read';
      if (minutes === 1) return '1 min read';
      return minutes + ' min read';
    };

    // ============ SEARCH HIGHLIGHTING ============
    const highlightSearch = (text, search) => {
      if (!search || !text) return escapeHtml(text || '');
      const escaped = escapeHtml(text);
      const searchLower = search.toLowerCase();
      const textLower = escaped.toLowerCase();
      const index = textLower.indexOf(searchLower);
      if (index === -1) return escaped;
      return escaped.slice(0, index) + 
             '<span class="search-highlight">' + escaped.slice(index, index + search.length) + '</span>' + 
             escaped.slice(index + search.length);
    };


    // ============ UNDO/REDO SYSTEM ============
    const pushToHistory = (actionType, data) => {
      const historyEntry = {
        type: actionType,
        data: JSON.parse(JSON.stringify(data)),
        timestamp: Date.now()
      };
      state.undoStack.push(historyEntry);
      if (state.undoStack.length > state.maxHistorySize) {
        state.undoStack.shift();
      }
      state.redoStack = []; // Clear redo stack on new action
    };

    const undo = () => {
      if (state.undoStack.length === 0) {
        showToast('Nothing to undo', 'info');
        return;
      }
      const entry = state.undoStack.pop();
      
      // Save current state to redo stack
      const currentData = JSON.parse(JSON.stringify(state.data));
      state.redoStack.push({
        type: entry.type,
        data: currentData,
        timestamp: Date.now()
      });
      
      // Restore previous state
      state.data = entry.data;
      state.selectedId = null;
      saveData();
      render();
      showToast('Undone', 'info');
    };

    const redo = () => {
      if (state.redoStack.length === 0) {
        showToast('Nothing to redo', 'info');
        return;
      }
      const entry = state.redoStack.pop();
      
      // Save current state to undo stack
      const currentData = JSON.parse(JSON.stringify(state.data));
      state.undoStack.push({
        type: entry.type,
        data: currentData,
        timestamp: Date.now()
      });
      
      // Apply redo state
      state.data = entry.data;
      state.selectedId = null;
      saveData();
      render();
      showToast('Redone', 'info');
    };

    const escapeHtml = (str) => {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    };

    // Debounce utility for performance optimization
    const debounce = (fn, delay) => {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn(...args), delay);
      };
    };

    // Throttle utility for rate-limiting frequent calls
    const throttle = (fn, limit) => {
      let inThrottle;
      return (...args) => {
        if (!inThrottle) {
          fn(...args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    };

    // Format duration in milliseconds to human-readable string
    const formatDuration = (ms) => {
      // Handle edge cases
      if (!Number.isFinite(ms) || ms < 0) {
        return 'permanently';
      }

      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) {
        return days === 1 ? '1 day' : `${days} days`;
      } else if (hours > 0) {
        return hours === 1 ? '1 hour' : `${hours} hours`;
      } else if (minutes > 0) {
        return minutes === 1 ? '1 minute' : `${minutes} minutes`;
      } else {
        return seconds === 1 ? '1 second' : `${seconds} seconds`;
      }
    };

    const getTheme = () => {
      const themeName = state.data?.settings?.theme || 'moonlight';
      return themes[themeName] || themes.moonlight;
    };

    // ============ DATA FUNCTIONS ============
    const getItems = () => {
      if (state.section === 'journal') return state.data.journal || [];
      if (state.section === 'passwords') return state.data.passwords || [];
      if (state.section === 'totp') return state.data.totp || [];
      if (state.section === 'notes') return state.data.notes || [];
      if (state.section === 'files') return state.showTrash ? (state.data.trash || []) : (state.data.files || []);
      return [];
    };

    const getItemCount = (section) => {
      if (section === 'journal') return (state.data.journal || []).length;
      if (section === 'passwords') return (state.data.passwords || []).length;
      if (section === 'totp') return (state.data.totp || []).length;
      if (section === 'notes') return (state.data.notes || []).length;
      if (section === 'files') return (state.data.files || []).length;
      return 0;
    };

    const getFolders = () => {
      if (state.section === 'journal') return state.data.journalFolders || [];
      if (state.section === 'passwords') return state.data.passwordFolders || [];
      if (state.section === 'notes') return state.data.noteFolders || [];
      if (state.section === 'files') return state.data.fileFolders || [];
      return [];
    };

    const getSortedFiltered = () => {
      let items = getItems();
      let result = [...items];

      if (state.selectedFolder) {
        result = result.filter(i => i.folderId === state.selectedFolder);
      } else if (!state.showTrash && state.section !== 'totp') {
        result = result.filter(i => !i.folderId);
      }

      if (state.search) {
        const q = state.search.toLowerCase();
        result = result.filter(i =>
          (i.title || i.name || i.issuer || '').toLowerCase().includes(q) ||
          (i.content || i.username || i.account || '').toLowerCase().includes(q)
        );
      }

      // Date filtering
      if (state.searchFilter !== 'all') {
        const now = Date.now();
        const day = 24 * 60 * 60 * 1000;
        let cutoff = 0;
        if (state.searchFilter === 'today') cutoff = now - day;
        else if (state.searchFilter === 'week') cutoff = now - (7 * day);
        else if (state.searchFilter === 'month') cutoff = now - (30 * day);
        result = result.filter(i => {
          const timestamp = i.modified || i.created || 0;
          return timestamp > 0 && timestamp >= cutoff;
        });
      }

      // Apply sort order from settings
      const sortOrder = state.data.settings?.sortOrder || 'newest';

      if (state.section === 'journal') {
        result.sort((a, b) => {
          // Pinned items always first
          if (a.pinned && !b.pinned) return -1;
          if (!a.pinned && b.pinned) return 1;
          // Then apply sort order
          if (sortOrder === 'oldest') return (a.created || 0) - (b.created || 0);
          if (sortOrder === 'alpha') return (a.title || '').localeCompare(b.title || '');
          if (sortOrder === 'modified') return (b.modified || 0) - (a.modified || 0);
          return (b.created || 0) - (a.created || 0); // newest (default)
        });
      } else {
        result.sort((a, b) => {
          const aName = a.name || a.issuer || a.title || '';
          const bName = b.name || b.issuer || b.title || '';
          if (sortOrder === 'oldest') return (a.created || 0) - (b.created || 0);
          if (sortOrder === 'alpha') return aName.localeCompare(bName);
          if (sortOrder === 'modified') return (b.modified || 0) - (a.modified || 0);
          return (b.created || 0) - (a.created || 0); // newest (default)
        });
      }

      return result;
    };

    const getSelected = () => {
      const items = getItems();
      return items.find(i => i.id === state.selectedId);
    };

    const getTotalStorage = () => {
      let total = 0;
      (state.data.files || []).forEach(f => total += f.size || 0);
      (state.data.trash || []).forEach(f => total += f.size || 0);
      return total;
    };

    const calculateVaultSize = () => getTotalStorage();

    // ============ SAVE / LOAD ============
    let saveTimeout = null;
    let pendingSaveData = null; // Track data to save to prevent race condition

    const saveData = async () => {
      if (saveTimeout) clearTimeout(saveTimeout);

      // Capture current state immediately to prevent race condition with vault lock
      if (state.loaded && !state.locked) {
        pendingSaveData = JSON.stringify(state.data);
      }

      saveTimeout = setTimeout(async () => {
        if (pendingSaveData) {
          try {
            await window.storage.set(STORAGE_KEY, pendingSaveData);
            pendingSaveData = null; // Only clear on success
          } catch (err) {
            console.error('Failed to save data:', err);
            // Don't clear pendingSaveData on failure - will be retried on next save
            showToast('Failed to save data. Will retry...', 'warning');
          }
        }
      }, 300);
    };

    // Force immediate save (used before locking)
    const saveDataImmediate = async () => {
      if (saveTimeout) clearTimeout(saveTimeout);
      if (state.loaded && !state.locked) {
        try {
          await window.storage.set(STORAGE_KEY, JSON.stringify(state.data));
        } catch (err) {
          console.error('Failed to save data:', err);
        }
      }
      pendingSaveData = null;
    };

    // ============ RENDER HELPERS ============
    const updateStateAndRender = (changes, skipRender = false) => {
      Object.assign(state, changes);
      if (!skipRender) render();
      saveData();
    };

    // ============ ACTIONS ============
    const unlock = async (password) => {
      // Check if locked out (frontend)
      if (state.lockoutUntil > Date.now()) {
        const remaining = Math.ceil((state.lockoutUntil - Date.now()) / 1000);
        showToast(`Too many failed attempts. Try again in ${remaining}s`, 'error');
        return false;
      }

      state.isLoading = true;
      state.loadingMessage = 'Unlocking vault...';
      render();

      try {
        // Use backend vault.unlock
        const result = await window.vault.unlock(password);

        // Handle permanent lock - vault must be reset
        if (result.permanentlyLocked) {
          state.permanentlyLocked = true;
          state.lockoutLevel = result.lockoutLevel;
          showToast('Vault permanently locked. Reset required.', 'error');
          render();
          return false;
        }

        // Handle backend rate limiting
        if (result.locked) {
          const remaining = result.remainingSeconds || 0;
          const lockoutLevel = result.lockoutLevel;
          state.lockoutUntil = Date.now() + (remaining * 1000);
          state.lockoutLevel = lockoutLevel;

          // Show warning about remaining lockouts
          let message = result.error || `Too many failed attempts. Try again in ${formatDuration(remaining * 1000)}.`;
          if (lockoutLevel && lockoutLevel.remainingLockouts <= 3) {
            message += ` Warning: ${lockoutLevel.remainingLockouts} lockout(s) remaining before permanent lock!`;
          }
          showToast(message, 'error');
          render();
          return false;
        }

        if (result.success) {
          // Load encrypted data from vault
          const res = await window.storage.get(STORAGE_KEY);
          if (res?.success && res.value) {
            const parsed = JSON.parse(res.value);
            state.data = {
              ...defaultData,
              ...parsed,
              totp: parsed.totp || [],
              trash: parsed.trash || [],
              fileLinks: parsed.fileLinks || [],
              fileFolders: parsed.fileFolders || [],
              settings: { ...defaultData.settings, ...(parsed.settings || {}) }
            };
            // Apply font size setting on load
            if (state.data.settings?.fontSize) {
              document.body.style.fontSize = state.data.settings.fontSize + 'px';
            }
          }

          // Don't store master password in renderer memory!
          state.locked = false;
          state.lastActivity = Date.now();
          state.failedAttempts = 0;
          state.lockoutUntil = 0;
          state.permanentlyLocked = false;
          state.lockoutLevel = null;
          render();
          startAutoLockTimer();
          startTotpTimer();
          return true;
        }

        // Show error with lockout level info if available
        if (result.lockoutLevel) {
          state.lockoutLevel = result.lockoutLevel;
          const { currentAttempts, maxAttempts, remainingLockouts } = result.lockoutLevel;
          let message = result.error || 'Invalid master password';
          if (remainingLockouts <= 5) {
            message += ` (${maxAttempts - currentAttempts} attempts left, ${remainingLockouts} lockouts before permanent lock)`;
          }
          showToast(message, 'error');
        }

        // Track failed attempts (frontend sync with backend)
        state.failedAttempts++;
        return false;
      } finally {
        state.isLoading = false;
        state.loadingMessage = '';
        render();
      }
    };

    /**
     * Reload vault data from backend storage
     * Used after import operations to sync frontend state
     */
    const loadData = async () => {
      try {
        const res = await window.storage.get(STORAGE_KEY);
        if (res?.success && res.value) {
          const parsed = JSON.parse(res.value);
          state.data = {
            ...defaultData,
            ...parsed,
            totp: parsed.totp || [],
            trash: parsed.trash || [],
            fileLinks: parsed.fileLinks || [],
            fileFolders: parsed.fileFolders || [],
            settings: { ...defaultData.settings, ...(parsed.settings || {}) }
          };
          // Apply font size setting on load
          if (state.data.settings?.fontSize) {
            document.body.style.fontSize = state.data.settings.fontSize + 'px';
          }
          render();
          return true;
        }
        return false;
      } catch (err) {
        console.error('Failed to load data:', err);
        showToast('Failed to reload data', 'error');
        return false;
      }
    };

    const setup = async (password) => {
      state.isLoading = true;
      state.loadingMessage = 'Creating vault...';
      render();

      try {
        // Initialize backend vault with master password
        const result = await window.vault.initialize(password);

        if (!result.success) {
          console.error('Vault initialization failed:', result.error);
          return false;
        }

        // Unlock the vault we just created
        const unlockResult = await window.vault.unlock(password);

        if (!unlockResult.success) {
          console.error('Vault unlock failed:', unlockResult.error);
          return false;
        }

        // Don't store master password in renderer memory!
        state.locked = false;
        state.setupMode = false;
        render();
        saveData();
        startAutoLockTimer();
        return true;
      } catch (err) {
        console.error('Exception during setup:', err);
        return false;
      } finally {
        state.isLoading = false;
        state.loadingMessage = '';
        render();
      }
    };

    const lock = async () => {
      // Save any pending data before locking to prevent data loss
      await saveDataImmediate();

      // Lock backend vault (clears encryption key from memory)
      await window.vault.lock();

      // Securely clear sensitive data from memory
      // masterKey no longer stored in renderer!
      state.privateKey = secureClear.string(state.privateKey);
      state.totpCodes = secureClear.totpCodes(state.totpCodes);

      // Reset state
      state.locked = true;
      state.privateLocked = true;
      state.selectedId = null;
      state.selectedFiles = [];

      // Clear any password inputs in DOM
      const passInputs = document.querySelectorAll('input[type="password"]');
      passInputs.forEach(input => { input.value = ''; });

      if (state.autoLockInterval) clearInterval(state.autoLockInterval);
      if (state.totpInterval) clearInterval(state.totpInterval);
      render();
    };

    const startAutoLockTimer = () => {
      if (state.autoLockInterval) clearInterval(state.autoLockInterval);
      state.autoLockInterval = setInterval(async () => {
        const minutes = state.data.settings?.autoLockMinutes || 5;
        if (Date.now() - state.lastActivity > minutes * 60 * 1000) {
          await lock();
        }
      }, 10000);
    };

    const resetActivityTimer = () => {
      state.lastActivity = Date.now();
    };

    // ============ TOTP TIMER ============
    const startTotpTimer = () => {
      if (state.totpInterval) clearInterval(state.totpInterval);
      // Only start timer if vault is unlocked
      if (state.locked) return;
      updateAllTotpCodes();
      state.totpInterval = setInterval(updateAllTotpCodes, 1000);
    };

    const updateAllTotpCodes = async () => {
      // Skip if not on TOTP section and no TOTP elements visible
      const totpItems = state.data.totp || [];
      if (totpItems.length === 0) return;

      // Generate codes only when needed (every 30 seconds or on first load)
      const remaining = TOTP.getTimeRemaining();
      const shouldRegenerate = remaining === 30 || Object.keys(state.totpCodes).length === 0;

      if (shouldRegenerate) {
        for (const item of totpItems) {
          if (item.secret) {
            const code = await TOTP.generate(item.secret);
            state.totpCodes[item.id] = code;
          }
        }
      }

      // Batch all DOM updates in a single requestAnimationFrame
      requestAnimationFrame(() => {
        // Cache theme lookup (only once per update)
        const theme = getTheme();
        const isLow = remaining <= 5;
        const lowColor = theme.danger;
        const normalColor = theme.accent;
        const mutedColor = theme.textMuted;
        const timerWidth = (remaining / 30 * 100) + '%';
        const circumference = 163.36;
        const strokeOffset = circumference - (remaining / 30 * circumference);

        // Update TOTP code displays (text and color)
        document.querySelectorAll('.totp-code-display').forEach(el => {
          const id = el.dataset.id;
          if (state.totpCodes[id]) {
            el.textContent = state.totpCodes[id];
          }
          el.style.color = isLow ? lowColor : normalColor;
        });

        // Update linear timer bars
        document.querySelectorAll('.totp-timer').forEach(el => {
          el.style.width = timerWidth;
          el.style.background = isLow ? lowColor : normalColor;
        });

        // Update circular countdown
        document.querySelectorAll('.totp-circle').forEach(el => {
          el.style.strokeDashoffset = strokeOffset;
          el.style.stroke = isLow ? lowColor : normalColor;
        });

        // Update countdown text
        document.querySelectorAll('.totp-countdown-container').forEach(container => {
          const numEl = container.querySelector('div > div:last-child');
          if (numEl) {
            numEl.textContent = remaining;
            numEl.style.color = isLow ? lowColor : mutedColor;
          }
        });

        // Update remaining seconds text
        document.querySelectorAll('.totp-remaining-text').forEach(el => {
          el.textContent = remaining + 's';
          el.style.color = isLow ? lowColor : mutedColor;
        });
      });
    };

    // ============ ITEM OPERATIONS ============
    const saveVersion = (item) => {
      if (!state.data.settings?.enableVersioning) return item;
      const version = { content: item.content, title: item.title, timestamp: Date.now() };
      const versions = [...(item.versions || []), version].slice(-20);
      return { ...item, versions };
    };

    const updateItem = (id, changes, skipVersion = false) => {
      pushToHistory('update', state.data);
      const dataKey = state.section === 'journal' ? 'journal' : state.section === 'passwords' ? 'passwords' : state.section === 'totp' ? 'totp' : state.section === 'notes' ? 'notes' : 'files';
      state.data[dataKey] = state.data[dataKey].map(i => {
        if (i.id !== id) return i;
        let updated = { ...i, ...changes, modified: Date.now() };
        if (!skipVersion && (changes.content !== undefined || changes.title !== undefined)) {
          updated = saveVersion(updated);
        }
        return updated;
      });
      saveData();

      // Update list item title in real-time without re-render
      if (changes.title !== undefined || changes.name !== undefined || changes.issuer !== undefined) {
        const listItem = document.querySelector(`.list-item[data-id="${id}"]`);
        if (listItem) {
          const titleEl = listItem.querySelector('.item-title, div[style*="font-weight: 500"], div[style*="font-weight:500"]');
          if (titleEl) {
            const newTitle = changes.title || changes.name || changes.issuer || 'Untitled';
            titleEl.textContent = newTitle || 'Untitled';
          }
        }
      }
    };

    const doRemoveItem = (id) => {
      pushToHistory('delete', state.data);
      if (state.section === 'files') {
        const file = state.data.files.find(f => f.id === id);
        if (file) {
          state.data.files = state.data.files.filter(f => f.id !== id);
          state.data.trash = [...(state.data.trash || []), { ...file, deletedAt: Date.now() }];
        }
      } else if (state.section === 'totp') {
        state.data.totp = state.data.totp.filter(i => i.id !== id);
      } else if (state.section === 'notes') {
        state.data.notes = state.data.notes.filter(i => i.id !== id);
      } else {
        const dataKey = state.section === 'journal' ? 'journal' : 'passwords';
        state.data[dataKey] = state.data[dataKey].filter(i => i.id !== id);
      }
      if (state.selectedId === id) state.selectedId = null;
      render();
      saveData();
    };

    const removeItem = (id) => {
      if (state.section === 'files') {
        doRemoveItem(id);
        showSaveIndicator('Moved to trash');
      } else if (state.section === 'totp') {
        showConfirm('Delete 2FA Entry', 'Are you sure you want to delete this 2FA entry? This action cannot be undone.', () => doRemoveItem(id));
      } else if (state.section === 'notes') {
        showConfirm('Delete Note', 'Are you sure you want to delete this private note? This action cannot be undone.', () => doRemoveItem(id));
      } else if (state.section === 'journal') {
        showConfirm('Delete Entry', 'Are you sure you want to delete this journal entry? This action cannot be undone.', () => doRemoveItem(id));
      } else if (state.section === 'passwords') {
        showConfirm('Delete Password', 'Are you sure you want to delete this password? This action cannot be undone.', () => doRemoveItem(id));
      }
    };

    const createJournal = (template = null) => {
      pushToHistory('create', state.data);
      const item = {
        id: generateId(),
        title: '',
        content: template ? template.content : '',
        created: Date.now(),
        modified: Date.now(),
        pinned: false,
        folderId: state.selectedFolder || null,
        images: [],
        versions: []
      };
      state.data.journal = [item, ...state.data.journal];
      state.selectedId = item.id;
      state.showTemplates = false;
      render();
      saveData();
    };

    const createPassword = (prefill = '') => {
      pushToHistory('create', state.data);
      const item = {
        id: generateId(),
        name: '',
        username: '',
        password: prefill,
        url: '',
        notes: '',
        created: Date.now(),
        modified: Date.now(),
        folderId: state.selectedFolder || null
      };
      state.data.passwords = [item, ...state.data.passwords];
      state.selectedId = item.id;
      state.showGen = false;
      render();
      saveData();
    };

    const createTotp = () => {
      pushToHistory('create', state.data);
      const item = {
        id: generateId(),
        issuer: '',
        account: '',
        secret: '',
        created: Date.now(),
        modified: Date.now()
      };
      state.data.totp = [item, ...(state.data.totp || [])];
      state.selectedId = item.id;
      render();
      saveData();
    };

    const createNote = () => {
      pushToHistory('create', state.data);
      const item = {
        id: generateId(),
        title: '',
        content: '',
        created: Date.now(),
        modified: Date.now(),
        pinned: false,
        folderId: state.selectedFolder || null
      };
      state.data.notes = [item, ...(state.data.notes || [])];
      state.selectedId = item.id;
      render();
      saveData();
    };

    const setupPrivatePassword = async () => {
      try {
        const password = document.getElementById('privatePasswordInput')?.value;
        const confirm = document.getElementById('privatePasswordConfirm')?.value;
        if (!password) {
          showToast('Password required', 'error');
          return;
        }
        if (password !== confirm) {
          showToast('Passwords do not match', 'error');
          return;
        }
        // Use backend vault to set private password
        const result = await window.vault.setPrivatePassword(password);
        if (!result.success) {
          console.error('Failed to set private password:', result.error, result.details);
          showToast(result.error || 'Failed to set password', 'error');
          return;
        }
        // Reload full data from backend to sync state (backend saved the hash)
        const res = await window.storage.get(STORAGE_KEY);
        if (res?.success && res.value) {
          const parsed = JSON.parse(res.value);
          // Deep merge backend data into state to get the real hash
          // Only merge security-related fields from backend, preserve arrays from state
          state.data = {
            ...state.data,
            privatePasswordHash: parsed.privatePasswordHash,
            privatePasswordSalt: parsed.privatePasswordSalt,
            privatePasswordIterations: parsed.privatePasswordIterations
          };
        }
        state.privateLocked = false;
        state.privateKey = ''; // Don't store password in renderer
        saveData(); // Save merged state to persist everything
        render();
        showToast('Private section password set', 'success');
      } catch (error) {
        console.error('Error setting up private password:', error);
        showToast('Failed to set password: ' + error.message, 'error');
      }
    };

    const unlockPrivate = async () => {
      try {
        const password = document.getElementById('privatePasswordInput')?.value;
        if (!password) {
          showToast('Please enter your password', 'error');
          return;
        }
        // Use backend vault to unlock private section
        const result = await window.vault.unlockPrivate(password);
        if (result.success) {
          state.privateLocked = false;
          state.privateKey = ''; // Don't store password in renderer
          render();
          showToast('Private section unlocked', 'success');
          return;
        }
        showToast('Incorrect password', 'error');
      } catch (error) {
        console.error('Error unlocking private section:', error);
        showToast('Failed to unlock private section', 'error');
      }
    };

    const resetPrivateSection = async () => {
      showConfirm('Reset Private Section?', 'This will permanently delete all private notes and reset the password. This cannot be undone.', async () => {
        try {
          // Use backend vault to reset private password
          const result = await window.vault.resetPrivate();
          if (!result.success) {
            showToast('Failed to reset private section', 'error');
            return;
          }
          state.data.notes = [];
          state.data.noteFolders = [];
          state.data.privatePasswordHash = null;
          state.privateLocked = true;
          state.privateKey = '';
          state.selectedId = null;
          state.selectedFolder = null;
          saveData();
          render();
          showToast('Private section has been reset', 'success');
        } catch (error) {
          console.error('Error resetting private section:', error);
          showToast('Failed to reset private section', 'error');
        }
      });
    };

    const createFolder = (type, name) => {
      if (!name.trim()) return;
      const folder = { id: generateId(), name: name.trim(), created: Date.now() };
      const key = type === 'journal' ? 'journalFolders' : type === 'passwords' ? 'passwordFolders' : type === 'notes' ? 'noteFolders' : 'fileFolders';
      state.data[key] = [...(state.data[key] || []), folder];
      state.showModal = null;
      state.modalData = {};
      render();
      saveData();
    };

    const deleteFolder = (folderId, type) => {
      showConfirm('Delete Folder', 'Delete this folder? Items inside will be moved out of the folder.', () => {
        const folderKey = type === 'journal' ? 'journalFolders' : type === 'passwords' ? 'passwordFolders' : type === 'notes' ? 'noteFolders' : 'fileFolders';
        const itemKey = type === 'journal' ? 'journal' : type === 'passwords' ? 'passwords' : type === 'notes' ? 'notes' : 'files';
        state.data[folderKey] = state.data[folderKey].filter(f => f.id !== folderId);
        state.data[itemKey] = state.data[itemKey].map(i => i.folderId === folderId ? { ...i, folderId: null } : i);
        if (state.selectedFolder === folderId) state.selectedFolder = null;
        render();
        saveData();
      });
    };

    // ============ DRAG AND DROP REORDER ============
    const handleDragStart = (e, item) => {
      state.draggedItem = item;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    };

    const handleDragEnd = (e) => {
      e.target.classList.remove('dragging');
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      state.draggedItem = null;
      state.dragOverItem = null;
    };

    const handleDragOver = (e, item) => {
      e.preventDefault();
      if (!state.draggedItem || !item || state.draggedItem.id === item.id) return;
      state.dragOverItem = item;
      e.currentTarget.classList.add('drag-over');
    };

    const handleDragLeave = (e) => {
      e.currentTarget.classList.remove('drag-over');
    };

    const handleDrop = (e, targetItem) => {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');

      if (!state.draggedItem || state.draggedItem.id === targetItem.id) return;

      const dataKey = state.section === 'journal' ? 'journal' : state.section === 'passwords' ? 'passwords' : state.section === 'totp' ? 'totp' : state.section === 'notes' ? 'notes' : 'files';
      const sourceArray = state.data[dataKey];
      if (!Array.isArray(sourceArray)) return;
      const items = [...sourceArray];
      const draggedIndex = items.findIndex(i => i.id === state.draggedItem.id);
      const targetIndex = items.findIndex(i => i.id === targetItem.id);

      if (draggedIndex === -1 || targetIndex === -1) return;

      // Remove dragged item and insert at target position
      // Adjust target index after splice if dragged item was before target
      const [removed] = items.splice(draggedIndex, 1);
      const adjustedTargetIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
      items.splice(adjustedTargetIndex, 0, removed);

      state.data[dataKey] = items;
      state.draggedItem = null;
      state.dragOverItem = null;
      render();
      saveData();
    };

    // ============ FILE OPERATIONS ============
    const DANGEROUS_FILE_TYPES = ['.exe', '.bat', '.cmd', '.sh', '.dll', '.so', '.dylib', '.app', '.vbs', '.ps1', '.scr', '.msi'];

    const getMaxFileSize = () => (state.data.settings?.maxFileSizeMB || 50) * 1024 * 1024;
    const getMaxVaultSize = () => (state.data.settings?.maxVaultSizeMB || 500) * 1024 * 1024;

    // Helper to read file as Promise
    const readFileAsDataURL = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (ev) => resolve(ev.target.result);
        reader.onerror = () => reject(new Error(`Failed to read "${file.name}"`));
        reader.readAsDataURL(file);
      });
    };

    const processFiles = async (fileList, forJournal = false) => {
      const files = Array.from(fileList);
      let filesProcessed = 0;
      let filesSkipped = 0;
      const maxFileSize = getMaxFileSize();
      const maxVaultSize = getMaxVaultSize();

      for (const file of files) {
        // File size validation
        if (file.size > maxFileSize) {
          showToast(`File "${file.name}" exceeds maximum size of ${state.data.settings?.maxFileSizeMB || 50}MB`, 'error');
          filesSkipped++;
          continue;
        }

        // Check vault size limit
        const totalVaultSize = calculateVaultSize();
        if (totalVaultSize + file.size > maxVaultSize) {
          showToast(`Adding this file would exceed vault size limit of ${state.data.settings?.maxVaultSizeMB || 500}MB`, 'warning');
          filesSkipped++;
          continue;
        }

        // Warn about potentially dangerous file types (check all extensions for double-extension attacks)
        const dotIndex = file.name.lastIndexOf('.');
        const fileExt = dotIndex !== -1 ? file.name.substring(dotIndex).toLowerCase() : '';
        const allExtensions = file.name.toLowerCase().match(/\.[^.]+/g) || [];
        const hasDangerousExt = allExtensions.some(ext => DANGEROUS_FILE_TYPES.includes(ext));
        // Also warn if file has no extension (could be renamed executable)
        if (hasDangerousExt) {
          showToast(`Warning: ${file.name} contains executable extension. Use caution.`, 'warning');
        } else if (dotIndex === -1 && file.size > 0) {
          showToast(`Warning: ${file.name} has no extension. Verify file type before opening.`, 'warning');
        }

        try {
          const fileData = await readFileAsDataURL(file);

          if (forJournal && getSelected()) {
            const image = { id: generateId(), name: file.name, data: fileData, created: Date.now() };
            state.data.journal = state.data.journal.map(j =>
              j.id === state.selectedId ? { ...j, images: [...(j.images || []), image] } : j
            );
          } else {
            // Use backend encryption for files
            let finalFileData = fileData;
            let isEncrypted = false;

            if (state.data.settings?.encryptFiles) {
              const result = await window.vault.encryptFile(fileData);
              if (result.success) {
                finalFileData = result.encrypted;
                isEncrypted = true;
              } else {
                showToast(`Failed to encrypt "${file.name}". File not added.`, 'error');
                filesSkipped++;
                continue;
              }
            }

            const item = {
              id: generateId(),
              name: file.name,
              type: file.type,
              size: file.size,
              data: finalFileData,
              encrypted: isEncrypted,
              created: Date.now(),
              folderId: state.selectedFolder || null
            };
            state.data.files = [item, ...state.data.files];
          }
          filesProcessed++;
        } catch (error) {
          console.error('Error processing file:', error);
          showToast(`Failed to process "${file.name}"`, 'error');
          filesSkipped++;
        }
      }

      // Save and render after all files processed
      if (filesProcessed > 0) {
        render();
        saveData();
      }

      // Show summary if multiple files
      if (files.length > 1 && filesProcessed > 0) {
        showToast(`Uploaded ${filesProcessed} file(s)${filesSkipped > 0 ? `, skipped ${filesSkipped}` : ''}`, 'success');
      }
    };

    const getFileData = async (file) => {
      // Use backend decryption for files
      if (file.encrypted) {
        const result = await window.vault.decryptFile(file.data);
        if (result.success) {
          return result.data;
        }
      }
      return file.data;
    };

    const downloadFile = async (file) => {
      try {
        const fileData = await getFileData(file);
        if (!fileData || fileData.length === 0) {
          showToast('Failed to download file - could not decrypt or file is empty', 'error');
          return;
        }
        const a = document.createElement('a');
        a.href = fileData;
        a.download = file.name;
        a.click();
      } catch (err) {
        showToast('Failed to download file', 'error');
      }
    };

    const restoreFromTrash = (id) => {
      const file = state.data.trash.find(f => f.id === id);
      if (file) {
        const { deletedAt, ...restoredFile } = file;
        state.data.trash = state.data.trash.filter(f => f.id !== id);
        state.data.files = [...state.data.files, restoredFile];
        state.selectedId = null;
        render();
        saveData();
      }
    };

    const permanentDelete = (id) => {
      showConfirm('Delete Permanently', 'This file will be permanently deleted. This action cannot be undone.', () => {
        state.data.trash = state.data.trash.filter(f => f.id !== id);
        if (state.selectedId === id) state.selectedId = null;
        render();
        saveData();
      });
    };

    const emptyTrash = () => {
      showConfirm('Empty Trash', 'All files in trash will be permanently deleted. This action cannot be undone.', () => {
        state.data.trash = [];
        state.selectedId = null;
        render();
        saveData();
      });
    };

    // ============ MISC ============
    let lastCopiedText = null;
    let clipboardClearTimeout = null;
    let clipboardCopyId = 0; // Unique ID to track copy operations and prevent race conditions

    const copyText = (text) => {
      // Increment copy ID to track this specific copy operation
      const currentCopyId = ++clipboardCopyId;

      navigator.clipboard.writeText(text).then(() => {
        lastCopiedText = text;

        // Auto-clear clipboard after timeout if enabled
        if (state.data.settings?.clearClipboard !== false) {
          const timeout = state.data.settings?.clipboardTimeout || 30;

          // Clear any existing timeout
          if (clipboardClearTimeout) {
            clearTimeout(clipboardClearTimeout);
            clipboardClearTimeout = null;
          }

          clipboardClearTimeout = setTimeout(() => {
            // Only clear if this is still the most recent copy operation
            if (currentCopyId !== clipboardCopyId) {
              return; // A newer copy has occurred, don't clear
            }

            // Try to read clipboard to verify, but clear anyway if we can't read
            navigator.clipboard.readText().then(current => {
              if (current === lastCopiedText) {
                navigator.clipboard.writeText('').catch(() => {});
              }
              // Always clear lastCopiedText from memory regardless of clipboard state
              lastCopiedText = null;
            }).catch(() => {
              // Can't read clipboard (permission denied) - clear it anyway for safety
              navigator.clipboard.writeText('').catch(() => {});
              lastCopiedText = null;
            });
            clipboardClearTimeout = null;
          }, timeout * 1000);
        }
      }).catch(() => {
        showToast('Failed to copy to clipboard', 'error');
      });
    };

    const doGenerate = () => {
      state.genResult = generatePassword(state.genLen, state.genOpts);
      render();
    };

    const exportData = () => {
      state.showModal = 'exportVault';
      state.modalData = { password: '', confirmPassword: '', encrypt: false };
      render();
    };

    const doExport = async (encrypt, password) => {
      try {
        const dateStr = new Date().toISOString().split('T')[0];
        let content, filename, type;

        if (encrypt && password) {
          // Use backend encryption for export
          const result = await window.vault.exportBackup(password);
          if (!result.success) {
            showToast('Export failed', 'error');
            return;
          }
          content = JSON.stringify(result.backup, null, 2);
          filename = `eterna-backup-encrypted-${dateStr}.json`;
          type = 'application/json';
        } else {
          // Unencrypted export (export full backup wrapper for checksum verification)
          const result = await window.vault.exportBackup(null);
          if (!result.success) {
            showToast('Export failed', 'error');
            return;
          }
          content = JSON.stringify(result.backup, null, 2);
          filename = `eterna-backup-${dateStr}.json`;
          type = 'application/json';
        }

        const blob = new Blob([content], { type });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);

        state.showModal = null;
        render();
        showToast(encrypt ? 'Encrypted backup exported' : 'Backup exported', 'success');
      } catch (err) {
        showToast('Export failed: ' + err.message, 'error');
      }
    };

    const importData = (file) => {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (ev) => {
        try {
          const content = ev.target.result;
          let parsed;

          try {
            parsed = JSON.parse(content);
          } catch {
            showToast('Invalid backup file', 'error');
            return;
          }

          // Check if encrypted backup
          if (parsed.encrypted && parsed.data) {
            state.showModal = 'importPassword';
            state.modalData = { backup: parsed, password: '' };  // Pass full backup object
            render();
            return;
          }

          // Unencrypted backup - check if it's a backup wrapper or raw data
          const isBackupWrapper = parsed.version && (parsed.encrypted === false || parsed.data);
          showConfirm('Import Data', 'This will replace all your current data with the imported data. Continue?', async () => {
            if (isBackupWrapper) {
              // Use backend to import with checksum verification
              const result = await window.vault.importBackup(parsed, null);
              if (!result.success) {
                showToast(result.error || 'Import failed', 'error');
                return;
              }
              await loadData();
            } else {
              // Legacy raw data format - validate structure
              if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {
                showToast('Invalid backup format', 'error');
                return;
              }
              // Ensure required arrays exist and are valid
              const validatedData = {
                ...defaultData,
                ...parsed,
                passwords: Array.isArray(parsed.passwords) ? parsed.passwords : [],
                journal: Array.isArray(parsed.journal) ? parsed.journal : [],
                totp: Array.isArray(parsed.totp) ? parsed.totp : [],
                files: Array.isArray(parsed.files) ? parsed.files : [],
                trash: Array.isArray(parsed.trash) ? parsed.trash : [],
                notes: Array.isArray(parsed.notes) ? parsed.notes : [],
                folders: Array.isArray(parsed.folders) ? parsed.folders : [],
                passwordFolders: Array.isArray(parsed.passwordFolders) ? parsed.passwordFolders : [],
                journalFolders: Array.isArray(parsed.journalFolders) ? parsed.journalFolders : [],
                noteFolders: Array.isArray(parsed.noteFolders) ? parsed.noteFolders : [],
                fileFolders: Array.isArray(parsed.fileFolders) ? parsed.fileFolders : [],
                settings: { ...defaultData.settings, ...(parsed.settings || {}) }
              };
              state.data = validatedData;
              render();
              saveData();
            }
            showToast('Data imported successfully', 'success');
          }, false);
        } catch (err) {
          showToast('Import failed: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
    };

    const doImportEncrypted = async (backup, password) => {
      try {
        // Use backend decryption for import (pass full backup object with iv, tag, salt)
        const result = await window.vault.importBackup(backup, password);
        if (!result.success) {
          showToast(result.error || 'Incorrect password or corrupted backup', 'error');
          return;
        }

        state.showModal = null;
        render();
        // Reload vault data from backend
        await loadData();
        showToast('Encrypted backup imported successfully', 'success');
      } catch (err) {
        showToast('Decryption failed: ' + err.message, 'error');
      }
    };

    const resetVault = () => {
      showConfirm(
        'Reset Entire Vault',
        'This will permanently delete ALL your data including journal entries, passwords, 2FA codes, files, and settings. This cannot be undone!',
        () => {
          // Show second confirmation
          showConfirm(
            'Are you absolutely sure?',
            'Type the word DELETE in the box below and click confirm to permanently erase everything.',
            async () => {
              // Actually reset - delete vault files on disk
              const result = await window.vault.reset();
              if (result.success) {
                state.data = { ...defaultData };
                state.masterKey = '';
                state.setupMode = true;
                state.locked = true;
                state.selectedId = null;
                state.section = 'journal';
                state.undoStack = [];
                state.redoStack = [];
                showToast('Vault has been reset', 'success');
                render();
              } else {
                showToast('Failed to reset vault: ' + result.error, 'error');
              }
            },
            true
          );
        },
        true
      );
    };

    const updateSettings = (key, value, showNotification = false, notificationText = '') => {
      if (!state.data.settings) {
        state.data.settings = { ...defaultData.settings };
      }

      // Validate numeric settings to prevent invalid values
      const numericRanges = {
        autoLockMinutes: { min: 1, max: 60 },
        maxFileSizeMB: { min: 1, max: 500 },
        maxVaultSizeMB: { min: 100, max: 5000 },
        fontSize: { min: 10, max: 24 },
        clipboardTimeout: { min: 5, max: 300 }
      };

      if (numericRanges[key]) {
        const range = numericRanges[key];
        const numValue = typeof value === 'number' ? value : parseInt(value, 10);
        if (!Number.isFinite(numValue) || numValue < range.min || numValue > range.max) {
          console.warn(`Invalid ${key} value: ${value}, using default`);
          return; // Reject invalid value
        }
        value = numValue;
      }

      state.data.settings = { ...state.data.settings, [key]: value };
      saveData();

      // Apply settings immediately
      if (key === 'theme') {
        const theme = getTheme();
        document.documentElement.style.setProperty('--accent', theme.accent);
        render();
      } else if (key === 'fontSize') {
        // Update display text
        const slider = document.getElementById('fontSizeSlider');
        if (slider && slider.parentElement) {
          const display = slider.parentElement.querySelector('span:last-child');
          if (display) display.textContent = value + 'px';
        }
        // Actually apply font size to the app
        document.body.style.fontSize = value + 'px';
      } else if (key === 'compactView' || key === 'sortOrder') {
        // Trigger re-render to apply compact view or sort order
        // Use setTimeout to avoid race condition with checkbox state
        setTimeout(() => render(), 0);
      }

      // Show notification if requested
      if (showNotification && notificationText) {
        showToast(notificationText, 'success');
      }
    };

    // ============ TOAST NOTIFICATIONS ============
    const toastIcons = {
      success: '',
      error: '',
      warning: '!',
      info: 'i'
    };

    const ensureToastContainer = () => {
      let container = document.getElementById('toastContainer');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container';
        container.setAttribute('role', 'alert');
        container.setAttribute('aria-live', 'polite');
        container.setAttribute('aria-atomic', 'true');
        document.body.appendChild(container);
      }
      return container;
    };

    const showToast = (message, type = 'success', duration = 3000) => {
      const container = ensureToastContainer();
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span class="toast-icon">${toastIcons[type] || toastIcons.info}</span>
        <span class="toast-message">${escapeHtml(String(message))}</span>
        <span class="toast-close" onclick="this.parentElement.remove()"></span>
      `;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'toastOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, duration);
      
      return toast;
    };

    // Alias for backward compatibility
    const showSaveIndicator = (message = 'Saved', type = 'success') => showToast(message, type);

    // ============ LOADING SPINNER ============
    let loadingCount = 0;
    const showLoading = (message = 'Loading...') => {
      loadingCount++;
      if (loadingCount === 1) {
        const theme = getTheme();
        const div = document.createElement('div');
        div.id = 'loadingOverlay';
        div.className = 'spinner-overlay';
        div.innerHTML = `
          <div style="text-align: center;">
            <div class="spinner spinner-large" style="color: ${theme.accent}; margin: 0 auto 16px;"></div>
            <div style="color: ${theme.text}; font-size: 14px;">${message}</div>
          </div>
        `;
        document.body.appendChild(div);
      }
    };

    const hideLoading = () => {
      loadingCount = Math.max(0, loadingCount - 1);
      if (loadingCount === 0) {
        const el = document.getElementById('loadingOverlay');
        if (el) el.remove();
      }
    };

    // ============ ERROR BOUNDARY ============
    const showError = (message, duration = 5000) => {
      const existing = document.getElementById('errorBanner');
      if (existing) existing.remove();

      const div = document.createElement('div');
      div.id = 'errorBanner';
      div.className = 'error-banner';
      div.innerHTML = `<span style="margin-right: 8px;">!</span> ${escapeHtml(String(message))}`;
      document.body.appendChild(div);

      setTimeout(() => {
        const el = document.getElementById('errorBanner');
        if (el) el.remove();
      }, duration);
    };

    const safeAsync = async (fn, errorMessage = 'An error occurred') => {
      try {
        return await fn();
      } catch (error) {
        console.error(error);
        showError(errorMessage);
        return null;
      }
    };

    // Global error handler
    window.onerror = (msg, url, line, col, error) => {
      console.error('Global error:', error);
      showError('Something went wrong. Please try again.');
      return false;
    };

    window.onunhandledrejection = (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      // Don't show error for minor issues
    };

    // ============ FAVICON UTILITY ============
    const getFavicon = (url) => {
      if (!url) return null;
      try {
        const domain = new URL(url.startsWith('http') ? url : 'https://' + url).hostname;
        return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
      } catch {
        return null;
      }
    };

    const getFaviconHtml = (url, title) => {
      const faviconUrl = getFavicon(url);
      // Safely get first character, defaulting to '?' if title is null/undefined/empty
      const firstChar = (title && title.length > 0) ? title[0].toUpperCase() : '?';
      if (faviconUrl) {
        return `<img src="${faviconUrl}" class="favicon" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" /><div class="favicon-placeholder" style="display:none;">${firstChar}</div>`;
      }
      return `<div class="favicon-placeholder">${firstChar}</div>`;
    };

    // ============ CONFIRMATION DIALOG ============
    const showConfirm = (title, message, onConfirm, isDanger = true) => {
      state.confirmDialog = { title, message, onConfirm, isDanger };
      renderConfirmDialog();
    };

    const hideConfirm = () => {
      state.confirmDialog = null;
      const el = document.getElementById('confirmDialog');
      if (el) el.remove();
    };

    const renderConfirmDialog = () => {
      const existing = document.getElementById('confirmDialog');
      if (existing) existing.remove();
      if (!state.confirmDialog) return;

      const theme = getTheme();
      const { title, message, onConfirm, isDanger } = state.confirmDialog;
      
      const div = document.createElement('div');
      div.id = 'confirmDialog';
      div.className = 'confirm-overlay';
      div.style.cssText = `--surface: ${theme.surface}; --border: ${theme.border}; --text: ${theme.text}; --text-muted: ${theme.textMuted}; --elevated: ${theme.elevated}; --accent: ${theme.accent};`;
      div.innerHTML = `
        <div class="confirm-dialog">
          <div class="confirm-title">${title}</div>
          <div class="confirm-message">${message}</div>
          <div class="confirm-buttons">
            <button class="confirm-btn cancel" id="confirmCancel">Cancel</button>
            <button class="confirm-btn ${isDanger ? 'danger' : 'primary'}" id="confirmOk">${isDanger ? 'Delete' : 'Confirm'}</button>
          </div>
        </div>
      `;
      document.body.appendChild(div);

      // Attach events
      document.getElementById('confirmCancel').addEventListener('click', hideConfirm);
      document.getElementById('confirmOk').addEventListener('click', () => {
        hideConfirm();
        if (onConfirm) onConfirm();
      });
      div.addEventListener('click', (e) => {
        if (e.target === div) hideConfirm();
      });
    };

    // ============ CONTEXT MENU ============
    const showContextMenu = (e, item, type) => {
      e.preventDefault();
      state.contextMenu = { x: e.clientX, y: e.clientY, item, type };
      renderContextMenu();
    };

    const hideContextMenu = () => {
      state.contextMenu = null;
      const menu = document.getElementById('contextMenu');
      if (menu) menu.remove();
    };

    const renderContextMenu = () => {
      const existing = document.getElementById('contextMenu');
      if (existing) existing.remove();
      if (!state.contextMenu) return;

      const theme = getTheme();
      const { x, y, item, type } = state.contextMenu;
      const folders = getFolders();

      let menuItems = [];

      if (type === 'journal') {
        menuItems = [
          { icon: '', label: 'Open', action: () => { state.selectedId = item.id; render(); } },
          { icon: item.pinned ? '' : '', label: item.pinned ? 'Unpin' : 'Pin', action: () => { updateItem(item.id, { pinned: !item.pinned }, true); render(); } },
          { divider: true },
          ...folders.map(f => ({ icon: '', label: `Move to ${f.name}`, action: () => { updateItem(item.id, { folderId: f.id }); render(); } })),
          { icon: '', label: 'Remove from folder', action: () => { updateItem(item.id, { folderId: null }); render(); }, show: item.folderId },
          { divider: folders.length > 0 },
          { icon: '', label: 'Delete', action: () => removeItem(item.id), danger: true }
        ];
      } else if (type === 'passwords') {
        menuItems = [
          { icon: '', label: 'Open', action: () => { state.selectedId = item.id; render(); } },
          { icon: '', label: 'Copy Username', action: () => { copyText(item.username); showSaveIndicator('Username copied'); } },
          { icon: '', label: 'Copy Password', action: () => { copyText(item.password); showSaveIndicator('Password copied'); } },
          { divider: true },
          ...folders.map(f => ({ icon: '', label: `Move to ${f.name}`, action: () => { updateItem(item.id, { folderId: f.id }); render(); } })),
          { icon: '', label: 'Remove from folder', action: () => { updateItem(item.id, { folderId: null }); render(); }, show: item.folderId },
          { divider: folders.length > 0 },
          { icon: '', label: 'Delete', action: () => removeItem(item.id), danger: true }
        ];
      } else if (type === 'totp') {
        menuItems = [
          { icon: '', label: 'Open', action: () => { state.selectedId = item.id; render(); } },
          { icon: '', label: 'Copy Code', action: () => { if (state.totpCodes[item.id]) { copyText(state.totpCodes[item.id]); showSaveIndicator('Code copied'); } } },
          { divider: true },
          { icon: '', label: 'Delete', action: () => removeItem(item.id), danger: true }
        ];
      } else if (type === 'notes') {
        menuItems = [
          { icon: '', label: 'Open', action: () => { state.selectedId = item.id; render(); } },
          { icon: item.pinned ? '' : '', label: item.pinned ? 'Unpin' : 'Pin', action: () => { updateItem(item.id, { pinned: !item.pinned }, true); render(); } },
          { icon: '', label: 'Copy Content', action: () => { copyText(item.content || ''); showSaveIndicator('Content copied'); } },
          { divider: true },
          ...folders.map(f => ({ icon: '', label: `Move to ${f.name}`, action: () => { updateItem(item.id, { folderId: f.id }); render(); } })),
          { icon: '', label: 'Remove from folder', action: () => { updateItem(item.id, { folderId: null }); render(); }, show: item.folderId },
          { divider: folders.length > 0 },
          { icon: '', label: 'Delete', action: () => removeItem(item.id), danger: true }
        ];
      } else if (type === 'files') {
        menuItems = [
          { icon: '', label: 'Open', action: () => { state.selectedId = item.id; render(); } },
          { icon: '', label: 'Download', action: () => downloadFile(item) },
          { divider: true },
          ...folders.map(f => ({ icon: '', label: `Move to ${f.name}`, action: () => { updateItem(item.id, { folderId: f.id }); render(); } })),
          { icon: '', label: 'Remove from folder', action: () => { updateItem(item.id, { folderId: null }); render(); }, show: item.folderId },
          { divider: folders.length > 0 },
          { icon: '', label: 'Delete', action: () => removeItem(item.id), danger: true }
        ];
      }

      const div = document.createElement('div');
      div.id = 'contextMenu';
      div.className = 'context-menu';
      div.style.cssText = `left: ${Math.min(x, window.innerWidth - 180)}px; top: ${Math.min(y, window.innerHeight - 300)}px; --surface: ${theme.surface}; --border: ${theme.border}; --accent-bg: ${theme.accent}15;`;

      div.innerHTML = menuItems
        .filter(m => m.show !== false)
        .map(m => m.divider
          ? '<div class="context-menu-divider"></div>'
          : `<div class="context-menu-item" data-action="${menuItems.indexOf(m)}" style="color: ${m.danger ? theme.danger : theme.text};">${m.icon} ${m.label}</div>`
        ).join('');

      document.body.appendChild(div);

      div.querySelectorAll('.context-menu-item').forEach(el => {
        el.addEventListener('click', () => {
          const idx = parseInt(el.dataset.action, 10);
          if (menuItems[idx]?.action) menuItems[idx].action();
          hideContextMenu();
        });
      });
    };

    // ============ DRAG TO FOLDER ============
    const handleFolderDragOver = (e, folderId) => {
      e.preventDefault();
      if (!state.draggedItem) return;
      e.currentTarget.classList.add('drag-over');
    };

    const handleFolderDragLeave = (e) => {
      e.currentTarget.classList.remove('drag-over');
    };

    const handleFolderDrop = (e, folderId) => {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      if (!state.draggedItem) return;

      const dataKey = state.section === 'journal' ? 'journal' : state.section === 'passwords' ? 'passwords' : 'files';
      state.data[dataKey] = state.data[dataKey].map(i =>
        i.id === state.draggedItem.id ? { ...i, folderId: folderId || null } : i
      );
      state.draggedItem = null;
      showSaveIndicator('Moved to folder');
      render();
      saveData();
    };

    // ============ QR SCANNER ============
    const openQrScanner = () => {
      state.showQrScanner = true;
      render();
    };

    const closeQrScanner = () => {
      if (state.cameraStream) {
        state.cameraStream.getTracks().forEach(t => t.stop());
        state.cameraStream = null;
      }
      state.showQrScanner = false;
      render();
    };

    const handleQrImageUpload = async (file) => {
      const reader = new FileReader();
      reader.onload = async (e) => {
        const uri = await QRScanner.scanFromImage(e.target.result);
        if (uri && uri.startsWith('otpauth://')) {
          const parsed = TOTP.parseOtpAuthUri(uri);
          if (parsed) {
            const item = {
              id: generateId(),
              issuer: parsed.issuer || '',
              account: parsed.account || '',
              secret: parsed.secret || '',
              created: Date.now(),
              modified: Date.now()
            };
            state.data.totp = [item, ...(state.data.totp || [])];
            state.selectedId = item.id;
            closeQrScanner();
            showSaveIndicator('2FA account added');
            saveData();
          } else {
            alert('Could not parse QR code. Please try pasting the URI manually.');
          }
        } else {
          alert('No valid QR code found. Please try a clearer image or paste the URI manually.');
        }
      };
      reader.readAsDataURL(file);
    };

    const handlePasteOtpUri = () => {
      const uri = prompt('Paste your otpauth:// URI:');
      if (uri) {
        const parsed = TOTP.parseOtpAuthUri(uri);
        if (parsed) {
          const item = {
            id: generateId(),
            issuer: parsed.issuer || '',
            account: parsed.account || '',
            secret: parsed.secret || '',
            created: Date.now(),
            modified: Date.now()
          };
          state.data.totp = [item, ...(state.data.totp || [])];
          state.selectedId = item.id;
          closeQrScanner();
          showSaveIndicator('2FA account added');
          render();
          saveData();
        } else {
          alert('Invalid otpauth:// URI. It should start with otpauth://totp/');
        }
      }
    };

    // ============ RENDER ============
    // Render batching with requestAnimationFrame to prevent multiple renders per frame
    let renderPending = false;
    const scheduleRender = () => {
      if (renderPending) return;
      renderPending = true;
      requestAnimationFrame(() => {
        renderPending = false;
        doRender();
      });
    };

    const doRender = () => {
      const app = document.getElementById('app');
      const theme = getTheme();

      document.body.style.background = theme.bg;
      document.body.style.color = theme.text;

      // Store focused element info
      const activeEl = document.activeElement;
      const activeId = activeEl?.id;
      const activeClass = activeEl?.className;
      const selectionStart = activeEl?.selectionStart;
      const selectionEnd = activeEl?.selectionEnd;

      if (!state.loaded) {
        app.innerHTML = `<div style="height: 100vh; display: flex; align-items: center; justify-content: center; color: ${theme.textMuted};">Loading...</div>`;
        return;
      }

      if (state.locked) {
        app.innerHTML = renderLockScreen(theme);
        attachLockScreenEvents();
        return;
      }

      app.innerHTML = renderMainApp(theme);
      attachMainAppEvents();

      // Restore focus
      if (activeId) {
        const newEl = document.getElementById(activeId);
        if (newEl) {
          newEl.focus();
          if (selectionStart !== undefined && newEl.setSelectionRange) {
            newEl.setSelectionRange(selectionStart, selectionEnd);
          }
        }
      }

      // Render loading overlay if needed
      if (state.isLoading) {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loadingOverlay';
        loadingOverlay.innerHTML = `
          <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px);">
            <div style="text-align: center;">
              <div style="font-size: 48px; margin-bottom: 16px; animation: spin 1s linear infinite;"></div>
              <div style="font-size: 16px; color: white; font-weight: 500;">${state.loadingMessage || 'Loading...'}</div>
            </div>
          </div>
          <style>
            @keyframes spin {
              from { transform: rotate(0deg); }
              to { transform: rotate(360deg); }
            }
          </style>
        `;
        document.body.appendChild(loadingOverlay);
      } else {
        // Remove loading overlay if it exists
        const existingOverlay = document.getElementById('loadingOverlay');
        if (existingOverlay) existingOverlay.remove();
      }
    };

    // Use scheduleRender as the default render function for batching
    const render = scheduleRender;

    const renderLockScreen = (theme) => {
      const isLockedOut = state.lockoutUntil > Date.now();
      const isPermanentlyLocked = state.permanentlyLocked;
      const lockoutLevel = state.lockoutLevel;
      const attemptsRemaining = lockoutLevel
        ? Math.max(0, lockoutLevel.maxAttempts - lockoutLevel.currentAttempts)
        : Math.max(0, 5 - state.failedAttempts);
      const lockoutsRemaining = lockoutLevel ? lockoutLevel.remainingLockouts : 10;

      // Permanent lock UI
      if (isPermanentlyLocked) {
        return `
        <div class="titlebar" style="position: fixed; top: 0; left: 0; right: 0; height: 40px; background: transparent; display: flex; justify-content: flex-end; align-items: center; padding-right: 8px; z-index: 100;">
          <div class="window-controls" role="group" aria-label="Window controls">
            <button id="minimizeBtn" class="window-control-btn minimize" aria-label="Minimize window" style="background: transparent;">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="${theme.textMuted}" aria-hidden="true"><rect y="5" width="12" height="2"/></svg>
            </button>
            <button id="maximizeBtn" class="window-control-btn maximize" aria-label="Maximize window" style="background: transparent;">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="${theme.textMuted}" stroke-width="1.5" aria-hidden="true"><rect x="1" y="1" width="10" height="10" rx="1"/></svg>
            </button>
            <button id="closeBtn" class="window-control-btn close" aria-label="Close window" style="background: transparent;">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="${theme.textMuted}" aria-hidden="true"><path d="M1 1L11 11M11 1L1 11" stroke="${theme.textMuted}" stroke-width="1.5"/></svg>
            </button>
          </div>
        </div>
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
          <div style="width: 420px; padding: 48px 40px; background: ${theme.surface}; border-radius: 16px; border: 1px solid ${theme.danger}40;">
            <div style="text-align: center; margin-bottom: 36px;">
              <div style="width: 64px; height: 64px; background: ${theme.danger}; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <span style="font-size: 32px;"></span>
              </div>
              <div style="font-size: 24px; font-weight: 600; color: ${theme.danger}; margin-bottom: 8px;">
                Vault Permanently Locked
              </div>
              <div style="font-size: 14px; color: ${theme.textMuted}; line-height: 1.5;">
                Too many failed unlock attempts. For security, this vault has been permanently locked.
              </div>
            </div>
            <div style="padding: 20px; background: ${theme.danger}10; border: 1px solid ${theme.danger}30; border-radius: 12px; margin-bottom: 24px;">
              <div style="font-size: 13px; color: ${theme.text}; margin-bottom: 12px;">
                <strong>What happened?</strong>
              </div>
              <div style="font-size: 12px; color: ${theme.textMuted}; line-height: 1.6;">
                After ${lockoutLevel?.totalFailedAttempts || 'multiple'} failed password attempts across ${lockoutLevel?.maxLockouts || 10} lockout periods, the vault was permanently locked to protect your data from brute-force attacks.
              </div>
            </div>
            <div style="padding: 20px; background: ${theme.warning}10; border: 1px solid ${theme.warning}30; border-radius: 12px; margin-bottom: 24px;">
              <div style="font-size: 13px; color: ${theme.warning}; margin-bottom: 8px;">
                <strong>Warning</strong>
              </div>
              <div style="font-size: 12px; color: ${theme.textMuted}; line-height: 1.6;">
                Resetting the vault will permanently delete all stored data including passwords, notes, files, and 2FA codes. This action cannot be undone.
              </div>
            </div>
            <button id="resetVaultBtn" style="width: 100%; padding: 14px; background: ${theme.danger}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 14px; font-weight: 600;">
              Reset Vault & Start Fresh
            </button>
            <div style="margin-top: 16px; text-align: center; font-size: 11px; color: ${theme.textFaint};">
              If you remember your password, the data is still encrypted on disk.
              <br/>Contact support for recovery options.
            </div>
          </div>
        </div>
        `;
      }

      return `
      <div class="titlebar" style="position: fixed; top: 0; left: 0; right: 0; height: 40px; background: transparent; display: flex; justify-content: flex-end; align-items: center; padding-right: 8px; z-index: 100;">
        <div class="window-controls" role="group" aria-label="Window controls">
          <button id="minimizeBtn" class="window-control-btn minimize" aria-label="Minimize window" style="background: transparent;">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="${theme.textMuted}" aria-hidden="true"><rect y="5" width="12" height="2"/></svg>
          </button>
          <button id="maximizeBtn" class="window-control-btn maximize" aria-label="Maximize window" style="background: transparent;">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="${theme.textMuted}" stroke-width="1.5" aria-hidden="true"><rect x="1" y="1" width="10" height="10" rx="1"/></svg>
          </button>
          <button id="closeBtn" class="window-control-btn close" aria-label="Close window" style="background: transparent;">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="${theme.textMuted}" aria-hidden="true"><path d="M1 1L11 11M11 1L1 11" stroke="${theme.textMuted}" stroke-width="1.5"/></svg>
          </button>
        </div>
      </div>
      <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
        <div style="width: 380px; padding: 48px 40px; background: ${theme.surface}; border-radius: 16px; border: 1px solid ${theme.border};">
          <div style="text-align: center; margin-bottom: 36px;">
            <div style="width: 48px; height: 48px; background: ${isLockedOut ? theme.danger : theme.accent}; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
              ${isLockedOut ? '<span style="font-size: 20px;"></span>' : '<svg width="28" height="28" viewBox="0 0 100 100" fill="none"><path d="M 15 50 C 15 30, 30 20, 42 20 C 54 20, 60 35, 60 50 C 60 65, 54 80, 42 80 C 30 80, 15 70, 15 50 M 60 50 C 60 35, 66 20, 78 20 C 90 20, 105 30, 105 50 C 105 70, 90 80, 78 80 C 66 80, 60 65, 60 50" transform="translate(-10, 0)" fill="none" stroke="white" stroke-width="10" stroke-linecap="round"/></svg>'}
            </div>
            <div style="font-size: 22px; font-weight: 600; color: ${theme.text}; margin-bottom: 8px;">
              ${isLockedOut ? 'Vault Locked' : state.setupMode ? 'Create Your Vault' : 'Welcome Back'}
            </div>
            <div style="font-size: 14px; color: ${theme.textMuted};">
              ${isLockedOut ? 'Too many failed attempts' : state.setupMode ? 'Set a master password' : 'Enter your master password'}
            </div>
          </div>
          ${isLockedOut ? `
            <div id="lockoutTimer" style="text-align: center; padding: 20px; background: ${theme.danger}15; border-radius: 8px; margin-bottom: 16px;">
              <div style="font-size: 32px; font-weight: 600; color: ${theme.danger}; margin-bottom: 4px;">--:--</div>
              <div style="font-size: 12px; color: ${theme.textMuted};">until unlock available</div>
            </div>
            ${lockoutsRemaining <= 3 ? `
              <div style="padding: 12px; background: ${theme.warning}15; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                <div style="font-size: 12px; color: ${theme.warning}; font-weight: 500;">
                  Warning: ${lockoutsRemaining} lockout${lockoutsRemaining !== 1 ? 's' : ''} remaining before permanent lock
                </div>
              </div>
            ` : ''}
          ` : `
            <div style="margin-bottom: 16px;">
              <input type="password" id="passInput" placeholder="Master password" autocomplete="current-password" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px;" autofocus />
            </div>
            ${state.setupMode ? `
              <div style="margin-bottom: 16px;">
                <input type="password" id="passConfirm" placeholder="Confirm password" autocomplete="new-password" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px;" />
              </div>
            ` : ''}
            <div id="passError" style="display: none; padding: 10px 14px; background: ${theme.danger}15; border-radius: 8px; color: ${theme.danger}; font-size: 13px; margin-bottom: 16px;"></div>
            <button id="unlockBtn" style="width: 100%; padding: 12px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">
              ${state.setupMode ? 'Create Vault' : 'Unlock'}
            </button>
            ${!state.setupMode && state.failedAttempts > 0 ? `
              <div style="margin-top: 12px; text-align: center; font-size: 12px; color: ${attemptsRemaining <= 2 ? theme.danger : theme.textMuted};">
                ${attemptsRemaining} attempt${attemptsRemaining !== 1 ? 's' : ''} remaining before lockout
                ${lockoutsRemaining <= 5 ? `<br/><span style="color: ${theme.warning};">(${lockoutsRemaining} lockout${lockoutsRemaining !== 1 ? 's' : ''} until permanent lock)</span>` : ''}
              </div>
            ` : ''}
          `}
        </div>
      </div>
    `;
    };

    const renderMainApp = (theme) => {
      const selected = getSelected();
      const items = getSortedFiltered();
      const folders = getFolders();

      return `
        <style>
          ::selection { background: ${theme.accent}40; }
          ::-webkit-scrollbar-thumb { background: ${theme.accent}30; }
          input:focus, textarea:focus, select:focus { border-color: ${theme.accent} !important; }
        </style>

        ${state.showModal ? renderModal(theme) : ''}
        ${state.showTemplates ? renderTemplatesModal(theme) : ''}
        ${state.showVersions && selected?.versions ? renderVersionsModal(theme, selected) : ''}
        ${state.showQrScanner ? renderQrScannerModal(theme) : ''}

        <div class="titlebar" style="position: sticky; top: 0; background: ${theme.surface}; border-bottom: 1px solid ${theme.border}; padding: 8px 12px 8px 16px; display: flex; align-items: center; justify-content: space-between; z-index: 100;">
          <div style="display: flex; align-items: center; gap: 24px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <svg width="28" height="28" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M 15 50 C 15 30, 30 20, 42 20 C 54 20, 60 35, 60 50 C 60 65, 54 80, 42 80 C 30 80, 15 70, 15 50 M 60 50 C 60 35, 66 20, 78 20 C 90 20, 105 30, 105 50 C 105 70, 90 80, 78 80 C 66 80, 60 65, 60 50" transform="translate(-10, 0)" fill="none" stroke="${theme.accent}" stroke-width="10" stroke-linecap="round"/>
              </svg>
              <div style="font-size: 16px; font-weight: 700; color: ${theme.accent}; letter-spacing: -0.02em;">Eterna</div>
            </div>
            <nav role="navigation" aria-label="Main navigation" style="display: flex; gap: 2px;">
              ${['journal', 'notes', 'passwords', 'totp', 'files', 'settings'].map(s => {
                const count = s !== 'settings' ? getItemCount(s) : 0;
                const label = s === 'totp' ? '2FA' : s === 'notes' ? 'Private' : s;
                const ariaLabel = `${label} section${count > 0 ? `, ${count} items` : ''}${state.section === s ? ', selected' : ''}`;
                return `
                <button class="nav-btn" data-section="${s}" role="tab" aria-label="${ariaLabel}" aria-selected="${state.section === s}" style="padding: 6px 12px; background: ${state.section === s ? theme.accent + '18' : 'transparent'}; border: none; border-radius: 5px; color: ${state.section === s ? theme.accent : theme.textMuted}; cursor: pointer; font-size: 12px; font-weight: 500; text-transform: capitalize; display: flex; align-items: center; gap: 4px;">
                  ${label}${count > 0 ? `<span style="font-size: 10px; opacity: 0.6;">(${count})</span>` : ''}
                </button>
              `;}).join('')}
            </nav>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div class="online-indicator ${state.isOnline ? 'online' : 'offline'}" style="font-size: 11px;">
              <div class="online-dot ${state.isOnline ? 'online' : 'offline'}"></div>
              ${state.isOnline ? 'Online' : 'Offline'}
            </div>
            <button id="lockBtn" aria-label="Lock vault" style="padding: 6px 12px; background: ${theme.danger}15; border: none; border-radius: 6px; color: ${theme.danger}; cursor: pointer; font-size: 12px; font-weight: 500;">Lock</button>
            <div class="window-controls" role="group" aria-label="Window controls">
              <button id="minimizeBtn" class="window-control-btn minimize" aria-label="Minimize window" style="background: transparent;">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="${theme.textMuted}" aria-hidden="true"><rect y="5" width="12" height="2"/></svg>
              </button>
              <button id="maximizeBtn" class="window-control-btn maximize" aria-label="Maximize window" style="background: transparent;">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="${theme.textMuted}" stroke-width="1.5" aria-hidden="true"><rect x="1" y="1" width="10" height="10" rx="1"/></svg>
              </button>
              <button id="closeBtn" class="window-control-btn close" aria-label="Close window" style="background: transparent;">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="${theme.textMuted}" aria-hidden="true"><path d="M1 1L11 11M11 1L1 11" stroke="${theme.textMuted}" stroke-width="1.5"/></svg>
              </button>
            </div>
          </div>
        </div>

        <div role="main" style="display: flex; height: calc(100vh - 49px); overflow: hidden;">
          ${state.section !== 'settings' ? renderSidebar(theme, items, folders, selected) : ''}
          ${renderDetail(theme, selected)}
        </div>
      `;
    };

    const renderSidebar = (theme, items, folders, selected) => `
      <div style="width: 320px; border-right: 1px solid ${theme.border}; display: flex; flex-direction: column; background: ${theme.surface}; height: 100%; overflow: hidden;">
        <div style="padding: 16px; border-bottom: 1px solid ${theme.border};">
          <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            ${state.section === 'journal' ? `
              <button id="newEntryBtn" style="flex: 1; padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">New Entry</button>
              <button id="newFolderBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">+ Folder</button>
            ` : ''}
            ${state.section === 'passwords' ? `
              <button id="newPassBtn" style="flex: 1; padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">New</button>
              <button id="genToggleBtn" style="padding: 9px 16px; background: ${state.showGen ? theme.accent : theme.elevated}; border: 1px solid ${state.showGen ? 'transparent' : theme.border}; border-radius: 8px; color: ${state.showGen ? '#fff' : theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Gen</button>
              <button id="newFolderBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">+ Folder</button>
            ` : ''}
            ${state.section === 'notes' ? (state.privateLocked ? `
              <div style="flex: 1; padding: 9px 16px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.textMuted}; font-size: 13px; text-align: center;"> Locked</div>
            ` : `
              <button id="newNoteBtn" style="flex: 1; padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">New Note</button>
              <button id="newFolderBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">+ Folder</button>
              <button id="lockPrivateBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;"></button>
            `) : ''}
            ${state.section === 'totp' ? `
              <button id="newTotpBtn" style="flex: 1; padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Add 2FA</button>
              <button id="scanQrBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Scan QR</button>
            ` : ''}
            ${state.section === 'files' ? `
              <button id="uploadBtn" style="flex: 1; padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Upload</button>
              <input type="file" id="fileInput" multiple style="display: none;" />
              <button id="newFolderBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">+ Folder</button>
            ` : ''}
          </div>
          <div class="search-container" style="position: relative;">
            <input type="text" id="searchInput" placeholder="Search..." value="${escapeHtml(state.search)}" aria-label="Search vault items" style="width: 100%; padding: 11px 40px 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px;" />
            <button id="searchFilterBtn" class="search-filter-btn" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); padding: 4px 8px; background: ${state.searchFilter !== 'all' ? theme.accent : theme.surfaceAlt}; border: 1px solid ${state.searchFilter !== 'all' ? theme.accent : theme.border}; border-radius: 4px; font-size: 11px; cursor: pointer; color: ${state.searchFilter !== 'all' ? '#fff' : theme.textMuted};">
              ${state.searchFilter === 'all' ? '' : state.searchFilter.charAt(0).toUpperCase() + state.searchFilter.slice(1)}
            </button>
            ${state.showSearchFilters ? `
              <div class="search-dropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: ${theme.surface}; border: 1px solid ${theme.border}; border-radius: 8px; padding: 8px; margin-top: 4px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; font-size: 12px; cursor: pointer; border-radius: 4px; background: ${state.searchFilter === 'all' ? theme.accent + '18' : 'transparent'};">
                  <input type="radio" name="searchFilter" value="all" ${state.searchFilter === 'all' ? 'checked' : ''} style="accent-color: ${theme.accent};" /> All time
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; font-size: 12px; cursor: pointer; border-radius: 4px; background: ${state.searchFilter === 'today' ? theme.accent + '18' : 'transparent'};">
                  <input type="radio" name="searchFilter" value="today" ${state.searchFilter === 'today' ? 'checked' : ''} style="accent-color: ${theme.accent};" /> Today
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; font-size: 12px; cursor: pointer; border-radius: 4px; background: ${state.searchFilter === 'week' ? theme.accent + '18' : 'transparent'};">
                  <input type="radio" name="searchFilter" value="week" ${state.searchFilter === 'week' ? 'checked' : ''} style="accent-color: ${theme.accent};" /> This week
                </label>
                <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; font-size: 12px; cursor: pointer; border-radius: 4px; background: ${state.searchFilter === 'month' ? theme.accent + '18' : 'transparent'};">
                  <input type="radio" name="searchFilter" value="month" ${state.searchFilter === 'month' ? 'checked' : ''} style="accent-color: ${theme.accent};" /> This month
                </label>
              </div>
            ` : ''}
          </div>

          ${state.section === 'files' ? `
            <div style="margin-top: 12px;">
              <div style="display: flex; justify-content: space-between; font-size: 11px; color: ${theme.textMuted}; margin-bottom: 4px;">
                <span>Storage Used</span>
                <span>${formatBytes(getTotalStorage())}</span>
              </div>
              <div style="height: 4px; background: ${theme.border}; border-radius: 2px; overflow: hidden;">
                <div style="height: 100%; width: ${Math.min((getTotalStorage() / (50 * 1024 * 1024)) * 100, 100)}%; background: ${theme.accent}; border-radius: 2px;"></div>
              </div>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button class="trash-toggle" data-show="false" style="flex: 1; padding: 6px 12px; background: ${!state.showTrash ? theme.accent : theme.elevated}; border: 1px solid ${!state.showTrash ? 'transparent' : theme.border}; border-radius: 8px; color: ${!state.showTrash ? '#fff' : theme.text}; cursor: pointer; font-size: 12px; font-weight: 500;">Files</button>
              <button class="trash-toggle" data-show="true" style="flex: 1; padding: 6px 12px; background: ${state.showTrash ? theme.accent : theme.elevated}; border: 1px solid ${state.showTrash ? 'transparent' : theme.border}; border-radius: 8px; color: ${state.showTrash ? '#fff' : theme.text}; cursor: pointer; font-size: 12px; font-weight: 500;">Trash ${state.data.trash?.length > 0 ? `(${state.data.trash.length})` : ''}</button>
            </div>
          ` : ''}
        </div>

        ${!state.showTrash && folders.length > 0 && !(state.section === 'notes' && state.privateLocked) ? `
          <div style="padding: 8px 12px; border-bottom: 1px solid ${theme.border};">
            <div class="folder-item folder-drop-zone" data-folder="" style="padding: 8px 12px; border-radius: 6px; cursor: pointer; background: ${!state.selectedFolder ? theme.accent + '18' : 'transparent'}; color: ${!state.selectedFolder ? theme.accent : theme.textMuted}; font-size: 13px; margin-bottom: 4px;">
              All Items (drop to unfolder)
            </div>
            ${folders.map(folder => `
              <div class="folder-item folder-drop-zone" data-folder="${folder.id}" style="padding: 8px 12px; border-radius: 6px; cursor: pointer; background: ${state.selectedFolder === folder.id ? theme.accent + '18' : 'transparent'}; color: ${state.selectedFolder === folder.id ? theme.accent : theme.textMuted}; font-size: 13px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
                <span> ${escapeHtml(folder.name)}</span>
                <button class="delete-folder-btn" data-folder="${folder.id}" style="background: none; border: none; color: ${theme.textFaint}; cursor: pointer; font-size: 12px; padding: 2px 6px;">&times;</button>
              </div>
            `).join('')}
          </div>
        ` : ''}

        ${state.section === 'passwords' && state.showGen ? renderPasswordGenerator(theme) : ''}

        ${state.section === 'files' && state.showTrash && state.data.trash?.length > 0 ? `
          <div style="padding: 8px 16px; border-bottom: 1px solid ${theme.border};">
            <button id="emptyTrashBtn" style="width: 100%; padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.danger}; cursor: pointer; font-size: 12px; font-weight: 500;">Empty Trash</button>
          </div>
        ` : ''}

        <div style="flex: 1; overflow: auto; padding: 12px;">
          ${state.section === 'notes' && state.privateLocked ? `
            <div style="padding: 32px; text-align: center; color: ${theme.textFaint}; font-size: 13px;">
              <div style="font-size: 24px; margin-bottom: 8px;"></div>
              Private section is locked
            </div>
          ` : items.length === 0 ? `
            <div style="padding: 32px; text-align: center; color: ${theme.textFaint}; font-size: 13px;">
              ${state.search ? 'No results' : state.showTrash ? 'Trash is empty' : 'Nothing here yet'}
            </div>
          ` : items.map(item => renderListItem(theme, item, selected)).join('')}
        </div>
      </div>
    `;

    const renderListItem = (theme, item, selected) => {
      const isSelected = state.selectedId === item.id;
      const isDraggable = !state.showTrash && state.section !== 'files';
      const compact = state.data.settings?.compactView;
      const padding = compact ? '10px 14px' : '14px 16px';
      const marginBottom = compact ? '4px' : '8px';

      if (state.section === 'journal') {
        return `
          <div class="list-item" data-id="${item.id}" draggable="${isDraggable}" style="padding: ${padding}; background: ${isSelected ? theme.elevated : theme.surface}; border: 1px solid ${isSelected ? theme.accent + '50' : theme.border}; border-radius: 10px; cursor: pointer; margin-bottom: ${marginBottom}; transition: all 0.15s;">
            <div style="font-weight: 500; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
              ${item.pinned ? '<span style="color: ' + theme.warning + '; font-size: 12px;"></span>' : ''}
              ${item.images?.length > 0 ? '<span style="font-size: 12px;"></span>' : ''}
              <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${item.title ? escapeHtml(item.title) : '<span style="color: ' + theme.textMuted + '">Untitled</span>'}
              </span>
            </div>
            <div style="font-size: 12px; color: ${theme.textMuted}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              ${item.content ? escapeHtml(item.content.slice(0, 50)) : 'Empty'}
            </div>
            <div style="font-size: 11px; color: ${theme.textFaint}; margin-top: 6px;">${formatDate(item.modified)}</div>
          </div>
        `;
      }

      if (state.section === 'passwords') {
        const pwStrength = calculatePasswordStrength(item.password);
        const isWeak = pwStrength.class === 'weak' || pwStrength.class === 'fair';
        return `
          <div class="list-item" data-id="${item.id}" draggable="${isDraggable}" style="padding: ${padding}; background: ${isSelected ? theme.elevated : theme.surface}; border: 1px solid ${isSelected ? theme.accent + '50' : theme.border}; border-radius: 10px; cursor: pointer; margin-bottom: ${marginBottom}; transition: all 0.15s;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="flex-shrink: 0;">
                ${getFaviconHtml(item.url, item.name)}
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: flex; align-items: center;">
                  <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name ? escapeHtml(item.name) : '<span style="color: ' + theme.textMuted + '">Unnamed</span>'}</span>
                  ${isWeak && item.password ? '<span class="item-badge weak">Weak</span>' : ''}
                </div>
                <div style="font-size: 12px; color: ${theme.textMuted}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.username ? escapeHtml(item.username) : 'No username'}</div>
              </div>
            </div>
          </div>
        `;
      }

      if (state.section === 'totp') {
        const code = state.totpCodes[item.id] || '------';
        const remaining = TOTP.getTimeRemaining();
        const isLow = remaining <= 5;
        // Try to create favicon URL from issuer name
        const issuerUrl = item.issuer ? 'https://' + item.issuer.toLowerCase().replace(/\s+/g, '') + '.com' : null;
        return `
          <div class="list-item" data-id="${item.id}" draggable="true" style="padding: ${padding}; background: ${isSelected ? theme.elevated : theme.surface}; border: 1px solid ${isSelected ? theme.accent + '50' : theme.border}; border-radius: 10px; cursor: pointer; margin-bottom: ${marginBottom}; transition: all 0.15s;">
            <div style="display: flex; align-items: flex-start; gap: 12px;">
              <div style="flex-shrink: 0;">
                ${getFaviconHtml(issuerUrl, item.issuer)}
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.issuer ? escapeHtml(item.issuer) : '<span style="color: ' + theme.textMuted + '">New 2FA</span>'}</div>
                <div style="font-size: 12px; color: ${theme.textMuted}; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.account ? escapeHtml(item.account) : 'No account'}</div>
                ${item.secret ? `
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="totp-code-display" data-id="${item.id}" style="font-family: monospace; font-size: 20px; letter-spacing: 3px; font-weight: 600; color: ${isLow ? theme.danger : theme.accent};">${code}</div>
                    <div style="flex: 1; display: flex; align-items: center; gap: 6px;">
                      <div style="flex: 1; height: 4px; background: ${theme.border}; border-radius: 2px; overflow: hidden;">
                        <div class="totp-timer" style="width: ${(remaining / 30 * 100)}%; height: 100%; background: ${isLow ? theme.danger : theme.accent}; border-radius: 2px; transition: width 1s linear;"></div>
                      </div>
                      <span style="font-size: 11px; color: ${isLow ? theme.danger : theme.textFaint}; min-width: 20px;">${remaining}s</span>
                    </div>
                  </div>
                ` : `<div style="font-size: 12px; color: ${theme.textFaint};">No secret configured</div>`}
              </div>
            </div>
          </div>
        `;
      }

      if (state.section === 'notes') {
        return `
          <div class="list-item" data-id="${item.id}" draggable="true" style="padding: ${padding}; background: ${isSelected ? theme.elevated : theme.surface}; border: 1px solid ${isSelected ? theme.accent + '50' : theme.border}; border-radius: 10px; cursor: pointer; margin-bottom: ${marginBottom}; transition: all 0.15s;">
            <div style="font-weight: 500; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;">
              ${item.pinned ? '<span style="color: ' + theme.warning + '; font-size: 12px;"></span>' : ''}
              <span style="font-size: 14px;"></span>
              <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${item.title ? escapeHtml(item.title) : '<span style="color: ' + theme.textMuted + '">Untitled Note</span>'}
              </span>
            </div>
            <div style="font-size: 12px; color: ${theme.textMuted}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              ${item.content ? escapeHtml(item.content.slice(0, 50)) : 'Empty note'}
            </div>
            <div style="font-size: 11px; color: ${theme.textFaint}; margin-top: 6px;">${formatDate(item.modified)}</div>
          </div>
        `;
      }

      if (state.section === 'files') {
        const fileType = getFileType(item);
        const iconData = fileIcons[fileType];
        return `
          <div class="list-item" data-id="${item.id}" style="padding: ${padding}; background: ${isSelected ? theme.elevated : theme.surface}; border: 1px solid ${isSelected ? theme.accent + '50' : theme.border}; border-radius: 10px; cursor: pointer; margin-bottom: ${marginBottom}; transition: all 0.15s;">
            <div style="display: flex; align-items: center;">
              <span style="font-size: 20px; margin-right: 10px;">${iconData.icon}</span>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  ${escapeHtml(item.name)}
                  ${item.encrypted ? '<span style="margin-left: 6px; font-size: 10px;"></span>' : ''}
                </div>
                <div style="font-size: 11px; color: ${theme.textMuted}; display: flex; justify-content: space-between;">
                  <span>${formatBytes(item.size)}</span>
                  <span>${formatDate(state.showTrash ? item.deletedAt : item.created)}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      return '';
    };

    const renderPasswordGenerator = (theme) => `
      <div style="padding: 16px; border-bottom: 1px solid ${theme.border}; background: ${theme.surfaceAlt};">
        <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 12px; font-weight: 600;">Password Generator</div>
        <div style="padding: 10px 12px; background: ${theme.surface}; border-radius: 6px; font-family: monospace; font-size: 13px; margin-bottom: 12px; min-height: 20px; word-break: break-all; color: ${state.genResult ? theme.text : theme.textFaint}; border: 1px solid ${theme.border};">
          ${state.genResult || 'Click generate...'}
        </div>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <span style="font-size: 12px; color: ${theme.textMuted};">Length</span>
          <input type="range" id="genLenSlider" min="8" max="40" value="${state.genLen}" style="flex: 1; accent-color: ${theme.accent};" />
          <span style="font-size: 13px; color: ${theme.accent}; min-width: 24px;">${state.genLen}</span>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px;">
          ${[{ key: 'lower', label: 'a-z' }, { key: 'upper', label: 'A-Z' }, { key: 'numbers', label: '0-9' }, { key: 'symbols', label: '!@#' }].map(o => `
            <button class="gen-opt-btn" data-opt="${o.key}" style="padding: 6px 10px; background: ${state.genOpts[o.key] ? theme.accent + '20' : theme.surface}; border: 1px solid ${state.genOpts[o.key] ? theme.accent + '40' : theme.border}; border-radius: 6px; color: ${state.genOpts[o.key] ? theme.accent : theme.textMuted}; cursor: pointer; font-size: 11px; font-family: monospace;">${o.label}</button>
          `).join('')}
        </div>
        <div style="display: flex; gap: 8px;">
          <button id="doGenerateBtn" style="flex: 1; padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Generate</button>
          ${state.genResult ? `
            <button id="copyGenBtn" style="flex: 1; padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Copy</button>
            <button id="useGenBtn" style="flex: 1; padding: 9px 16px; background: ${theme.success}20; border: 1px solid ${theme.success}30; border-radius: 8px; color: ${theme.success}; cursor: pointer; font-size: 13px; font-weight: 500;">Use</button>
          ` : ''}
        </div>
      </div>
    `;

    const renderDetail = (theme, selected) => {
      if (state.section === 'settings') return renderSettings(theme);
      if (state.section === 'journal') return selected ? renderJournalDetail(theme, selected) : renderEmptyState(theme, 'journal');
      if (state.section === 'passwords') return selected ? renderPasswordDetail(theme, selected) : renderEmptyState(theme, 'passwords');
      if (state.section === 'totp') return selected ? renderTotpDetail(theme, selected) : renderEmptyState(theme, 'totp');
      if (state.section === 'notes') return state.privateLocked ? renderPrivateLockScreen(theme) : (selected ? renderNoteDetail(theme, selected) : renderEmptyState(theme, 'notes'));
      if (state.section === 'files') return selected ? renderFileDetail(theme, selected) : renderEmptyState(theme, 'files');
      return '<div style="flex: 1;"></div>';
    };

    const renderPrivateLockScreen = (theme) => {
      const hasPassword = !!state.data.privatePasswordHash;
      return `
        <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
          <div style="text-align: center; max-width: 400px; padding: 40px;">
            <div style="font-size: 32px; margin-bottom: 16px; font-weight: bold;">LOCKED</div>
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 8px;">Private Section</div>
            <div style="font-size: 13px; color: ${theme.textMuted}; margin-bottom: 24px;">
              ${hasPassword ? 'Enter your private password to access your secure notes.' : 'Set up a separate password to protect your private notes.'}
            </div>
            <input type="password" id="privatePasswordInput" placeholder="${hasPassword ? 'Private password' : 'Create private password'}" autocomplete="${hasPassword ? 'current-password' : 'new-password'}" style="width: 100%; padding: 12px 16px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; margin-bottom: 12px; text-align: center;" />
            ${!hasPassword ? `<input type="password" id="privatePasswordConfirm" placeholder="Confirm password" autocomplete="new-password" style="width: 100%; padding: 12px 16px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; margin-bottom: 12px; text-align: center;" />` : ''}
            <button id="unlockPrivateBtn" style="width: 100%; padding: 12px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 14px; font-weight: 500; margin-bottom: 16px;">
              ${hasPassword ? 'Unlock Private' : 'Set Password'}
            </button>
            ${hasPassword ? `
              <button id="resetPrivateBtn" style="padding: 8px 16px; background: transparent; border: 1px solid ${theme.danger}30; border-radius: 6px; color: ${theme.danger}; cursor: pointer; font-size: 12px;">
                Forgot Password? Reset Private Section
              </button>
            ` : ''}
          </div>
        </div>
      `;
    };

    const renderEmptyState = (theme, section) => {
      const messages = {
        journal: { text: 'Select or create an entry', btn: 'New Entry', btnId: 'newEntryBtnEmpty' },
        passwords: { text: 'Select or create a password', btn: 'New Password', btnId: 'newPassBtnEmpty' },
        totp: { text: 'Select or add a 2FA account', btn: 'Add 2FA', btnId: 'newTotpBtnEmpty' },
        notes: { text: 'Select or create a private note', btn: 'New Note', btnId: 'newNoteBtnEmpty' },
        files: { text: state.showTrash ? 'Select a file from trash' : 'Select a file or drag & drop', btn: 'Upload Files', btnId: 'uploadBtnEmpty' }
      };
      const m = messages[section];
      return `
        <div id="fileDropZone" style="flex: 1; display: flex; align-items: center; justify-content: center; height: 100%; overflow: auto;">
          <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">${section === 'totp' ? '' : section === 'notes' ? '' : section === 'files' ? '' : ''}</div>
            <div style="font-size: 13px; color: ${theme.textMuted}; margin-bottom: 16px;">${m.text}</div>
            ${!state.showTrash || section !== 'files' ? `<button id="${m.btnId}" style="padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">${m.btn}</button>` : ''}
          </div>
        </div>
      `;
    };

    const renderJournalDetail = (theme, selected) => `
      <div style="flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden;">
        <div style="padding: 10px 20px; border-bottom: 1px solid ${theme.border}; display: flex; justify-content: space-between; align-items: center; background: ${theme.surface}; flex-shrink: 0;">
          <div style="display: flex; gap: 4px;">
            <button class="edit-mode-btn" data-mode="write" style="padding: 6px 12px; background: ${state.editMode === 'write' ? theme.accent + '18' : 'transparent'}; border: none; border-radius: 5px; color: ${state.editMode === 'write' ? theme.accent : theme.textMuted}; cursor: pointer; font-size: 12px; font-weight: 500;">Write</button>
            <button class="edit-mode-btn" data-mode="read" style="padding: 6px 12px; background: ${state.editMode === 'read' ? theme.accent + '18' : 'transparent'}; border: none; border-radius: 5px; color: ${state.editMode === 'read' ? theme.accent : theme.textMuted}; cursor: pointer; font-size: 12px; font-weight: 500;">Read</button>
          </div>
          <div style="display: flex; gap: 8px;">
            ${state.data.settings?.enableVersioning && selected.versions?.length > 0 ? `<button id="historyBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">History (${selected.versions.length})</button>` : ''}
            <button id="addImageBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Add Image</button>
            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" />
            <button id="pinBtn" style="padding: 9px 16px; background: ${selected.pinned ? theme.accent : theme.elevated}; border: 1px solid ${selected.pinned ? 'transparent' : theme.border}; border-radius: 8px; color: ${selected.pinned ? '#fff' : theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">${selected.pinned ? ' Pinned' : 'Pin'}</button>
            <button id="deleteItemBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.danger}; cursor: pointer; font-size: 13px; font-weight: 500;">Delete</button>
          </div>
        </div>
        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0;">
          <div style="padding: 20px 28px 0;">
            <div style="font-size: 11px; color: ${theme.textFaint}; margin-bottom: 10px;">${formatDate(selected.created)}</div>
            <input type="text" id="titleInput" value="${escapeHtml(selected.title)}" placeholder="Title" style="width: 100%; padding: 0; background: transparent; border: none; color: ${theme.text}; font-size: 24px; font-weight: 600;" />
          </div>
          ${selected.images?.length > 0 ? `
            <div style="padding: 16px 28px 0; display: flex; gap: 12px; flex-wrap: wrap;">
              ${selected.images.map(img => `
                <div style="position: relative;">
                  <img src="${img.data}" alt="${escapeHtml(img.name)}" style="height: 80px; border-radius: 6px; object-fit: cover;" />
                  <button class="remove-image-btn" data-image="${img.id}" style="position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; background: ${theme.danger}; border: none; border-radius: 50%; color: #fff; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;">&times;</button>
                </div>
              `).join('')}
            </div>
          ` : ''}
          <div style="flex: 1; padding: 16px 28px 28px; overflow: auto;">
            ${state.editMode === 'write' ? `
              <textarea id="contentInput" placeholder="Start writing..." style="width: 100%; height: 100%; background: transparent; border: none; color: ${theme.text}; resize: none; line-height: 1.7; font-size: ${state.data.settings?.fontSize || 15}px;">${escapeHtml(selected.content)}</textarea>
            ` : `
              <div style="line-height: 1.7; font-size: ${state.data.settings?.fontSize || 15}px; white-space: pre-wrap;">${selected.content ? escapeHtml(selected.content) : '<span style="color: ' + theme.textFaint + '">Nothing here</span>'}</div>
            `}
          </div>
          <div style="padding: 12px 28px; border-top: 1px solid ${theme.border}; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
            <div style="font-size: 11px; color: ${theme.textFaint}; display: flex; gap: 16px;">
              <span>${getTextStats(selected.content).words} words</span>
              <span>${getTextStats(selected.content).chars} characters</span>
              <span>${formatReadingTime(getTextStats(selected.content).readingTime)}</span>
            </div>
            <div style="font-size: 11px; color: ${theme.textFaint};">
              Last edited ${formatDate(selected.modified)}
            </div>
          </div>
        </div>
      </div>
    `;

    const renderPasswordDetail = (theme, selected) => {
      const strength = calculatePasswordStrength(selected.password);
      const isDuplicate = checkDuplicatePassword(selected.password, selected.id);
      return `
      <div style="flex: 1; padding: 28px; overflow-y: auto; height: 100%;">
        <div style="max-width: 480px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              ${getFaviconHtml(selected.url, selected.name)}
              <div style="font-size: 20px; font-weight: 600;">${selected.name ? escapeHtml(selected.name) : 'Unnamed'}</div>
            </div>
            <button id="deleteItemBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.danger}; cursor: pointer; font-size: 13px; font-weight: 500;">Delete</button>
          </div>

          ${isDuplicate ? `<div style="padding: 10px 14px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; color: #f59e0b;">
            <span>!</span> This password is used by another account
          </div>` : ''}

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; font-weight: 600;">Name</label>
            <input type="text" id="field_name" class="pass-field" data-key="name" value="${escapeHtml(selected.name)}" placeholder="e.g., Gmail" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px;" />
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; font-weight: 600;">Username / Email</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="field_username" class="pass-field" data-key="username" value="${escapeHtml(selected.username)}" placeholder="" style="flex: 1; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px;" />
              <button class="copy-field-btn" data-key="username" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Copy</button>
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; font-weight: 600;">Password</label>
            <div style="display: flex; gap: 8px;">
              <input type="${!state.showPass[selected.id] ? 'password' : 'text'}" id="field_password" class="pass-field" data-key="password" value="${escapeHtml(selected.password)}" placeholder="" style="flex: 1; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; font-family: monospace;" />
              <button class="toggle-pass-btn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">${state.showPass[selected.id] ? 'Hide' : 'Show'}</button>
              <button class="copy-field-btn" data-key="password" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Copy</button>
            </div>
            ${selected.password ? `<div class="strength-meter"><div class="strength-meter-fill ${strength.class}"></div></div>
            <div class="strength-label ${strength.class}">${strength.label} password</div>` : ''}
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; font-weight: 600;">Website</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="field_url" class="pass-field" data-key="url" value="${escapeHtml(selected.url)}" placeholder="https://" style="flex: 1; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px;" />
              ${selected.url ? `<button id="openUrlBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Open</button>` : ''}
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; font-weight: 600;">Notes</label>
            <textarea id="notesInput" placeholder="Additional notes..." rows="3" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; resize: vertical;">${escapeHtml(selected.notes || '')}</textarea>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: ${theme.textFaint};">
            <span>Modified ${formatDate(selected.modified)}</span>
            <span>Created ${formatDate(selected.created)}</span>
          </div>
        </div>
      </div>
    `;
    };

    const renderTotpDetail = (theme, selected) => {
      const code = state.totpCodes[selected.id] || '------';
      const remaining = TOTP.getTimeRemaining();
      return `
        <div style="flex: 1; padding: 28px; overflow-y: auto; height: 100%;">
          <div style="max-width: 480px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px;">
              <div style="font-size: 20px; font-weight: 600;">${selected.issuer ? escapeHtml(selected.issuer) : 'New 2FA Account'}</div>
              <button id="deleteItemBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.danger}; cursor: pointer; font-size: 13px; font-weight: 500;">Delete</button>
            </div>

            ${selected.secret ? `
              <div style="text-align: center; padding: 32px; background: ${theme.surfaceAlt}; border-radius: 12px; margin-bottom: 24px;">
                <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 12px;">Current Code</div>
                <div class="totp-code-display" data-id="${selected.id}" style="font-family: monospace; font-size: 36px; letter-spacing: 6px; font-weight: 600; color: ${theme.accent}; margin-bottom: 8px;">${code}</div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                  <div style="width: 150px; height: 6px; background: ${theme.border}; border-radius: 3px; overflow: hidden;">
                    <div class="totp-timer" style="width: ${(remaining / 30 * 100)}%; height: 100%; background: ${remaining <= 5 ? theme.danger : theme.accent}; border-radius: 3px; transition: width 1s linear;"></div>
                  </div>
                  <span class="totp-remaining-text" style="font-size: 12px; color: ${theme.textMuted};">${remaining}s</span>
                </div>
                <button id="copyTotpBtn" style="margin-top: 16px; padding: 9px 24px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Copy Code</button>
              </div>
            ` : ''}

            <div style="margin-bottom: 20px;">
              <label style="display: block; font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; font-weight: 600;">Service / Issuer</label>
              <input type="text" id="totpIssuer" value="${escapeHtml(selected.issuer)}" placeholder="e.g., Google, GitHub" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px;" />
            </div>

            <div style="margin-bottom: 20px;">
              <label style="display: block; font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; font-weight: 600;">Account</label>
              <input type="text" id="totpAccount" value="${escapeHtml(selected.account)}" placeholder="e.g., user@email.com" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px;" />
            </div>

            <div style="margin-bottom: 20px;">
              <label style="display: block; font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 8px; font-weight: 600;">Secret Key (Base32)</label>
              <input type="text" id="totpSecret" value="${escapeHtml(selected.secret)}" placeholder="e.g., JBSWY3DPEHPK3PXP" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; font-family: monospace; text-transform: uppercase;" />
              <div style="font-size: 11px; color: ${theme.textFaint}; margin-top: 6px;">Enter the secret key from your authenticator setup</div>
            </div>

            <div style="font-size: 11px; color: ${theme.textFaint};">Added ${formatDate(selected.created)}</div>
          </div>
        </div>
      `;
    };

    const renderNoteDetail = (theme, selected) => {
      return `
        <div style="flex: 1; display: flex; flex-direction: column;">
          <div style="padding: 10px 20px; border-bottom: 1px solid ${theme.border}; display: flex; justify-content: space-between; align-items: center; background: ${theme.surface};">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 18px;"></span>
              <span style="font-weight: 500;">Private Note</span>
            </div>
            <div style="display: flex; gap: 8px;">
              <button id="pinNoteBtn" style="padding: 6px 12px; background: ${selected.pinned ? theme.accent : theme.elevated}; border: 1px solid ${selected.pinned ? 'transparent' : theme.border}; border-radius: 6px; color: ${selected.pinned ? '#fff' : theme.text}; cursor: pointer; font-size: 12px; font-weight: 500;">${selected.pinned ? ' Pinned' : 'Pin'}</button>
              <button id="deleteItemBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.danger}; cursor: pointer; font-size: 13px; font-weight: 500;">Delete</button>
            </div>
          </div>
          <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0;">
            <div style="padding: 20px 28px 0;">
              <div style="font-size: 11px; color: ${theme.textFaint}; margin-bottom: 10px;">${formatDate(selected.created)}</div>
              <input type="text" id="noteTitleInput" value="${escapeHtml(selected.title)}" placeholder="Note title..." style="width: 100%; padding: 0; background: transparent; border: none; font-size: 24px; font-weight: 600; color: ${theme.text};" />
            </div>
            <div style="flex: 1; padding: 16px 28px 28px; overflow: auto;">
              <textarea id="noteContentInput" placeholder="Write your secure note here..." style="width: 100%; height: 100%; padding: 0; background: transparent; border: none; resize: none; line-height: 1.7; font-size: ${state.data.settings.fontSize}px; color: ${theme.text};">${escapeHtml(selected.content)}</textarea>
            </div>
          </div>
          <div style="padding: 12px 28px; border-top: 1px solid ${theme.border}; font-size: 11px; color: ${theme.textFaint};">
            Last modified ${formatFullDate(selected.modified)} &middot; Encrypted with AES-256-GCM
          </div>
        </div>
      `;
    };

    const renderFileDetail = (theme, selected) => {
      const fileType = getFileType(selected);
      const iconData = fileIcons[fileType];
      const isImage = fileType === 'image';
      const isVideo = fileType === 'video';
      const isAudio = fileType === 'audio';
      const isPdf = selected.name?.toLowerCase().endsWith('.pdf');
      
      return `
        <div id="fileDetailDropZone" style="flex: 1; display: flex; flex-direction: column;">
          <div style="padding: 10px 20px; border-bottom: 1px solid ${theme.border}; display: flex; justify-content: space-between; align-items: center; background: ${theme.surface};">
            <div style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 20px;">${iconData.icon}</span>
              ${escapeHtml(selected.name)}
            </div>
            <div style="display: flex; gap: 8px;">
              ${!state.showTrash ? `
                <button id="downloadBtn" style="padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Download</button>
                <button id="deleteItemBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.danger}; cursor: pointer; font-size: 13px; font-weight: 500;">Delete</button>
              ` : `
                <button id="restoreBtn" style="padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Restore</button>
                <button id="permDeleteBtn" style="padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.danger}; cursor: pointer; font-size: 13px; font-weight: 500;">Delete Forever</button>
              `}
            </div>
          </div>
          <div id="filePreviewArea" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 28px; overflow: auto;">
            ${isImage && selected.data ? `
              <img src="${selected.data}" alt="${escapeHtml(selected.name)}" style="max-width: 100%; max-height: calc(100% - 60px); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);" />
              <div style="margin-top: 16px; font-size: 13px; color: ${theme.textFaint};">
                ${escapeHtml(selected.name)} &middot; ${formatBytes(selected.size)}
              </div>
            ` : isVideo && selected.data ? `
              <video src="${selected.data}" controls style="max-width: 100%; max-height: calc(100% - 60px); border-radius: 8px;"></video>
              <div style="margin-top: 16px; font-size: 13px; color: ${theme.textFaint};">
                ${escapeHtml(selected.name)} &middot; ${formatBytes(selected.size)}
              </div>
            ` : isAudio && selected.data ? `
              <div style="text-align: center; padding: 40px;">
                <div style="font-size: 64px; margin-bottom: 24px;">${iconData.icon}</div>
                <div style="font-size: 16px; margin-bottom: 8px;">${escapeHtml(selected.name)}</div>
                <audio src="${selected.data}" controls style="width: 100%; max-width: 400px;"></audio>
                <div style="margin-top: 16px; font-size: 13px; color: ${theme.textFaint};">${formatBytes(selected.size)}</div>
              </div>
            ` : `
              <div style="text-align: center; color: ${theme.textMuted};">
                <div style="font-size: 64px; margin-bottom: 16px;">${iconData.icon}</div>
                <div style="font-size: 16px; margin-bottom: 4px;">${escapeHtml(selected.name)}</div>
                <div style="font-size: 13px; color: ${theme.textFaint}; margin-bottom: 8px;">${formatBytes(selected.size)}</div>
                ${selected.encrypted ? `<div style="font-size: 12px; color: ${theme.success};"> AES-256 Encrypted</div>` : ''}
                <div style="margin-top: 16px; font-size: 12px; color: ${theme.textFaint};">
                  Added ${formatDate(selected.created)}
                </div>
              </div>
            `}
          </div>
        </div>
      `;
    };

    const renderSettings = (theme) => `
      <div style="flex: 1; height: 100%; overflow-y: auto; overflow-x: hidden;">
        <div style="padding: 40px 48px; max-width: 700px; margin: 0 auto;">
          <div style="font-size: 24px; font-weight: 600; margin-bottom: 8px;">Settings</div>
          <div style="font-size: 13px; color: ${theme.textMuted}; margin-bottom: 32px;">Customize your vault experience</div>

          <!-- Appearance Section -->
          <div style="margin-bottom: 32px;">
            <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 14px; font-weight: 600;">Appearance</div>
            <div style="padding: 20px; background: ${theme.surface}; border-radius: 12px; border: 1px solid ${theme.border};">
              <div style="margin-bottom: 20px;">
                <div style="font-weight: 500; margin-bottom: 10px;">Theme</div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                  ${Object.entries(themes).map(([key, t]) => `
                    <button class="theme-btn" data-theme="${key}" style="padding: 14px; background: ${state.data.settings?.theme === key ? t.accent + '18' : theme.elevated}; border: 1px solid ${state.data.settings?.theme === key ? t.accent + '50' : theme.border}; border-radius: 8px; color: ${state.data.settings?.theme === key ? t.accent : theme.text}; cursor: pointer; font-size: 13px; text-align: left; display: flex; align-items: center; gap: 10px;">
                      <div style="width: 24px; height: 24px; background: ${t.accent}; border-radius: 6px;"></div>
                      <span style="font-weight: 500;">${t.name}</span>
                    </button>
                  `).join('')}
                </div>
              </div>
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="font-weight: 500;">Font Size</span>
                  <span style="color: ${theme.textMuted}; font-size: 13px;">${state.data.settings?.fontSize || 14}px</span>
                </div>
                <input type="range" id="fontSizeSlider" min="12" max="18" value="${state.data.settings?.fontSize || 14}" style="width: 100%; accent-color: ${theme.accent};" />
              </div>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <div>
                  <div style="font-weight: 500;">Compact View</div>
                  <div style="font-size: 12px; color: ${theme.textMuted}; margin-top: 2px;">Reduce spacing in lists</div>
                </div>
                <input type="checkbox" id="compactViewCheck" ${state.data.settings?.compactView ? 'checked' : ''} style="accent-color: ${theme.accent}; width: 18px; height: 18px;" />
              </label>
            </div>
          </div>

          <!-- Security Section -->
          <div style="margin-bottom: 32px;">
            <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 14px; font-weight: 600;">Security</div>
            <div style="padding: 20px; background: ${theme.surface}; border-radius: 12px; border: 1px solid ${theme.border};">
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="font-weight: 500;">Auto-Lock Timer</span>
                </div>
                <select id="autoLockSelect" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; cursor: pointer;">
                  <option value="1" ${state.data.settings?.autoLockMinutes === 1 ? 'selected' : ''}>1 minute</option>
                  <option value="5" ${state.data.settings?.autoLockMinutes === 5 ? 'selected' : ''}>5 minutes</option>
                  <option value="15" ${state.data.settings?.autoLockMinutes === 15 ? 'selected' : ''}>15 minutes</option>
                  <option value="30" ${state.data.settings?.autoLockMinutes === 30 ? 'selected' : ''}>30 minutes</option>
                  <option value="60" ${state.data.settings?.autoLockMinutes === 60 ? 'selected' : ''}>1 hour</option>
                  <option value="0" ${state.data.settings?.autoLockMinutes === 0 ? 'selected' : ''}>Never</option>
                </select>
              </div>
              <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="font-weight: 500;">Max Login Attempts</span>
                </div>
                <select id="maxAttemptsSelect" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; cursor: pointer;">
                  <option value="3" ${state.data.settings?.maxLoginAttempts === 3 ? 'selected' : ''}>3 attempts</option>
                  <option value="5" ${state.data.settings?.maxLoginAttempts === 5 ? 'selected' : ''}>5 attempts</option>
                  <option value="10" ${state.data.settings?.maxLoginAttempts === 10 ? 'selected' : ''}>10 attempts</option>
                </select>
              </div>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid ${theme.border};">
                <div>
                  <div style="font-weight: 500;">Auto-Clear Clipboard</div>
                  <div style="font-size: 12px; color: ${theme.textMuted}; margin-top: 2px;">Clear copied passwords after ${state.data.settings?.clipboardTimeout || 30}s</div>
                </div>
                <input type="checkbox" id="clearClipboardCheck" ${state.data.settings?.clearClipboard !== false ? 'checked' : ''} style="accent-color: ${theme.accent}; width: 18px; height: 18px;" />
              </label>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; margin-bottom: 16px;">
                <div>
                  <div style="font-weight: 500;">Encrypt Uploaded Files</div>
                  <div style="font-size: 12px; color: ${theme.textMuted}; margin-top: 2px;">AES-256-GCM encryption</div>
                </div>
                <input type="checkbox" id="encryptFilesCheck" ${state.data.settings?.encryptFiles ? 'checked' : ''} style="accent-color: ${theme.accent}; width: 18px; height: 18px;" />
              </label>
              <div style="margin-bottom: 16px;">
                <div style="font-weight: 500; margin-bottom: 8px;">Max File Size</div>
                <div style="font-size: 12px; color: ${theme.textMuted}; margin-bottom: 8px;">Maximum size for individual file uploads</div>
                <select id="maxFileSizeSelect" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; cursor: pointer;">
                  <option value="10" ${state.data.settings?.maxFileSizeMB === 10 ? 'selected' : ''}>10 MB</option>
                  <option value="25" ${state.data.settings?.maxFileSizeMB === 25 ? 'selected' : ''}>25 MB</option>
                  <option value="50" ${state.data.settings?.maxFileSizeMB === 50 || !state.data.settings?.maxFileSizeMB ? 'selected' : ''}>50 MB (Default)</option>
                  <option value="100" ${state.data.settings?.maxFileSizeMB === 100 ? 'selected' : ''}>100 MB</option>
                  <option value="250" ${state.data.settings?.maxFileSizeMB === 250 ? 'selected' : ''}>250 MB</option>
                </select>
              </div>
              <div style="margin-bottom: 16px;">
                <div style="font-weight: 500; margin-bottom: 8px;">Max Vault Size</div>
                <div style="font-size: 12px; color: ${theme.textMuted}; margin-bottom: 8px;">Maximum total size of all stored data</div>
                <select id="maxVaultSizeSelect" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; cursor: pointer;">
                  <option value="100" ${state.data.settings?.maxVaultSizeMB === 100 ? 'selected' : ''}>100 MB</option>
                  <option value="250" ${state.data.settings?.maxVaultSizeMB === 250 ? 'selected' : ''}>250 MB</option>
                  <option value="500" ${state.data.settings?.maxVaultSizeMB === 500 || !state.data.settings?.maxVaultSizeMB ? 'selected' : ''}>500 MB (Default)</option>
                  <option value="1000" ${state.data.settings?.maxVaultSizeMB === 1000 ? 'selected' : ''}>1 GB</option>
                  <option value="2000" ${state.data.settings?.maxVaultSizeMB === 2000 ? 'selected' : ''}>2 GB</option>
                </select>
              </div>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <div>
                  <div style="font-weight: 500;">Show Password Strength</div>
                  <div style="font-size: 12px; color: ${theme.textMuted}; margin-top: 2px;">Display strength indicator when viewing passwords</div>
                </div>
                <input type="checkbox" id="showStrengthCheck" ${state.data.settings?.showPasswordStrength !== false ? 'checked' : ''} style="accent-color: ${theme.accent}; width: 18px; height: 18px;" />
              </label>
            </div>
          </div>

          <!-- Behavior Section -->
          <div style="margin-bottom: 32px;">
            <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 14px; font-weight: 600;">Behavior</div>
            <div style="padding: 20px; background: ${theme.surface}; border-radius: 12px; border: 1px solid ${theme.border};">
              <div style="margin-bottom: 20px;">
                <div style="font-weight: 500; margin-bottom: 8px;">Default Section</div>
                <select id="defaultSectionSelect" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; cursor: pointer;">
                  <option value="journal" ${state.data.settings?.defaultSection === 'journal' ? 'selected' : ''}>Journal</option>
                  <option value="passwords" ${state.data.settings?.defaultSection === 'passwords' ? 'selected' : ''}>Passwords</option>
                  <option value="totp" ${state.data.settings?.defaultSection === 'totp' ? 'selected' : ''}>2FA Codes</option>
                  <option value="notes" ${state.data.settings?.defaultSection === 'notes' ? 'selected' : ''}>Private</option>
                  <option value="files" ${state.data.settings?.defaultSection === 'files' ? 'selected' : ''}>Files</option>
                </select>
              </div>
              <div style="margin-bottom: 20px;">
                <div style="font-weight: 500; margin-bottom: 8px;">Sort Order</div>
                <select id="sortOrderSelect" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; cursor: pointer;">
                  <option value="newest" ${state.data.settings?.sortOrder === 'newest' ? 'selected' : ''}>Newest First</option>
                  <option value="oldest" ${state.data.settings?.sortOrder === 'oldest' ? 'selected' : ''}>Oldest First</option>
                  <option value="alpha" ${state.data.settings?.sortOrder === 'alpha' ? 'selected' : ''}>Alphabetical</option>
                  <option value="modified" ${state.data.settings?.sortOrder === 'modified' ? 'selected' : ''}>Recently Modified</option>
                </select>
              </div>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; margin-bottom: 16px;">
                <div>
                  <div style="font-weight: 500;">Enable Version History</div>
                  <div style="font-size: 12px; color: ${theme.textMuted}; margin-top: 2px;">Keep up to 20 previous versions of entries</div>
                </div>
                <input type="checkbox" id="enableVersioningCheck" ${state.data.settings?.enableVersioning ? 'checked' : ''} style="accent-color: ${theme.accent}; width: 18px; height: 18px;" />
              </label>
              <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                <div>
                  <div style="font-weight: 500;">Confirm Before Delete</div>
                  <div style="font-size: 12px; color: ${theme.textMuted}; margin-top: 2px;">Show confirmation dialog before deleting items</div>
                </div>
                <input type="checkbox" id="confirmDeleteCheck" ${state.data.settings?.confirmDelete !== false ? 'checked' : ''} style="accent-color: ${theme.accent}; width: 18px; height: 18px;" />
              </label>
            </div>
          </div>

          <!-- Data Section -->
          <div style="margin-bottom: 32px;">
            <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 14px; font-weight: 600;">Data Management</div>
            <div style="padding: 20px; background: ${theme.surface}; border-radius: 12px; border: 1px solid ${theme.border};">
              <div style="margin-bottom: 20px;">
                <div style="font-weight: 500; margin-bottom: 8px;">Export & Import</div>
                <div style="font-size: 12px; color: ${theme.textMuted}; margin-bottom: 12px;">Backup your vault or restore from a previous backup</div>
                <div style="display: flex; gap: 10px;">
                  <button id="exportBtn" style="flex: 1; padding: 10px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Export Vault</button>
                  <label style="flex: 1; padding: 10px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500; text-align: center;">
                    Import Vault
                    <input type="file" id="importInput" accept=".json" style="display: none;" />
                  </label>
                </div>
              </div>
              <div style="padding-top: 16px; border-top: 1px solid ${theme.border};">
                <div style="font-weight: 500; margin-bottom: 8px;">Change Master Password</div>
                <div style="font-size: 12px; color: ${theme.textMuted}; margin-bottom: 12px;">Update your vault's master password</div>
                <button id="changePasswordBtn" style="padding: 10px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Change Password</button>
              </div>
            </div>
          </div>

          <!-- Audit Log Section -->
          <div style="margin-bottom: 32px;">
            <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 14px; font-weight: 600;">Security Audit Log</div>
            <div style="padding: 20px; background: ${theme.surface}; border-radius: 12px; border: 1px solid ${theme.border};">
              <div style="font-weight: 500; margin-bottom: 8px;">Activity Monitor</div>
              <div style="font-size: 12px; color: ${theme.textMuted}; margin-bottom: 12px;">Track security events and access history</div>
              <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                <button id="viewAuditLogBtn" style="flex: 1; padding: 10px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">View Audit Log</button>
                <button id="exportAuditLogBtn" style="flex: 1; padding: 10px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Export Log</button>
                <button id="clearAuditLogBtn" style="flex: 1; padding: 10px 16px; background: ${theme.danger}20; border: 1px solid ${theme.danger}50; border-radius: 8px; color: ${theme.danger}; cursor: pointer; font-size: 13px; font-weight: 500;">Clear Log</button>
              </div>
              <div style="font-size: 11px; color: ${theme.textFaint}; line-height: 1.5;">
                The audit log tracks vault unlocks, password changes, failed login attempts, and other security-relevant events. All logs are encrypted with your vault key.
              </div>
            </div>
          </div>

          <!-- Stats Section -->
          <div style="margin-bottom: 32px;">
            <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 14px; font-weight: 600;">Vault Statistics</div>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
              ${[
                { label: 'Entries', val: state.data.journal?.length || 0, icon: '' },
                { label: 'Passwords', val: state.data.passwords?.length || 0, icon: 'Key' },
                { label: '2FA', val: state.data.totp?.length || 0, icon: '' },
                { label: 'Private', val: state.data.notes?.length || 0, icon: '' },
                { label: 'Files', val: state.data.files?.length || 0, icon: '' }
              ].map(s => `
                <div style="padding: 16px 12px; background: ${theme.surface}; border-radius: 10px; border: 1px solid ${theme.border}; text-align: center;">
                  <div style="font-size: 20px; margin-bottom: 4px;">${s.icon}</div>
                  <div style="font-size: 22px; font-weight: 600; color: ${theme.accent};">${s.val}</div>
                  <div style="font-size: 10px; color: ${theme.textMuted}; margin-top: 2px;">${s.label}</div>
                </div>
              `).join('')}
            </div>
            <div style="margin-top: 12px; padding: 14px 16px; background: ${theme.surface}; border-radius: 10px; border: 1px solid ${theme.border}; display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 13px; color: ${theme.textMuted};">Storage Used</span>
              <span style="font-size: 13px; font-weight: 500;">${formatBytes(getTotalStorage())}</span>
            </div>
          </div>

          <!-- About Section -->
          <div style="margin-bottom: 32px;">
            <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 14px; font-weight: 600;">About</div>
            <div style="padding: 20px; background: ${theme.surface}; border-radius: 12px; border: 1px solid ${theme.border};">
              <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                <svg width="48" height="48" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" style="border-radius: 12px; box-shadow: 0 4px 12px ${theme.accent}40; background: ${theme.accent}; padding: 8px;">
                  <path d="M 15 50 C 15 30, 30 20, 42 20 C 54 20, 60 35, 60 50 C 60 65, 54 80, 42 80 C 30 80, 15 70, 15 50 M 60 50 C 60 35, 66 20, 78 20 C 90 20, 105 30, 105 50 C 105 70, 90 80, 78 80 C 66 80, 60 65, 60 50" transform="translate(-10, 0)" fill="none" stroke="white" stroke-width="8" stroke-linecap="round" opacity="0.95"/>
                </svg>
                <div>
                  <div style="font-weight: 600; font-size: 16px;">Eterna</div>
                  <div style="font-size: 12px; color: ${theme.textMuted};">Version ${state.appVersion}</div>
                </div>
              </div>
              <div style="font-size: 13px; color: ${theme.textMuted}; line-height: 1.6; margin-bottom: 16px;">
                A secure, offline-first vault for your passwords, journals, 2FA codes, and sensitive files. Built with AES-256-GCM encryption and PBKDF2 key derivation to keep your data protected.
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 12px;">
                <div style="display: flex; align-items: center; gap: 8px; color: ${theme.textMuted};">
                  <span style="color: ${theme.accent};">&#10003;</span> AES-256-GCM Encryption
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: ${theme.textMuted};">
                  <span style="color: ${theme.accent};">&#10003;</span> 600,000 PBKDF2 Iterations
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: ${theme.textMuted};">
                  <span style="color: ${theme.accent};">&#10003;</span> TOTP Authenticator
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: ${theme.textMuted};">
                  <span style="color: ${theme.accent};">&#10003;</span> Local Storage Only
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: ${theme.textMuted};">
                  <span style="color: ${theme.accent};">&#10003;</span> Rate-Limited Auth
                </div>
                <div style="display: flex; align-items: center; gap: 8px; color: ${theme.textMuted};">
                  <span style="color: ${theme.accent};">&#10003;</span> Encrypted Audit Log
                </div>
              </div>
            </div>
          </div>

          <!-- Updates Section -->
          <div style="margin-bottom: 32px;">
            <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 14px; font-weight: 600;">Updates</div>
            <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 16px; background: ${theme.surfaceAlt}; border-radius: 12px; border: 1px solid ${theme.border};">
              <div>
                <div style="font-weight: 500;">Auto-Update</div>
                <div style="font-size: 12px; color: ${theme.textMuted}; margin-top: 2px;">Automatically check for and install updates</div>
              </div>
              <input type="checkbox" id="autoUpdateCheck" ${state.data.settings?.autoUpdate === true ? 'checked' : ''} style="accent-color: ${theme.accent}; width: 18px; height: 18px;" />
            </label>
            <div id="updateStatusContainer" style="margin-top: 12px; padding: 12px 16px; background: ${theme.surfaceAlt}; border-radius: 8px; border: 1px solid ${theme.border};">
              ${state.updateStatus === 'available' ? `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 13px; font-weight: 500; color: ${theme.accent};">Update Available!</div>
                    <div style="font-size: 12px; color: ${theme.textMuted};">Version ${state.updateVersion || 'new'} is ready to download</div>
                  </div>
                  <button id="downloadUpdateBtn" style="padding: 8px 16px; background: ${theme.accent}; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 12px; font-weight: 500;">Download</button>
                </div>
              ` : state.updateStatus === 'downloading' ? `
                <div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-size: 13px; font-weight: 500;">Downloading update...</div>
                    <div style="font-size: 12px; color: ${theme.textMuted};">${state.updatePercent || 0}%</div>
                  </div>
                  <div style="height: 4px; background: ${theme.border}; border-radius: 2px; overflow: hidden;">
                    <div style="width: ${state.updatePercent || 0}%; height: 100%; background: ${theme.accent}; transition: width 0.3s;"></div>
                  </div>
                </div>
              ` : state.updateStatus === 'downloaded' ? `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 13px; font-weight: 500; color: #22c55e;">Update Ready!</div>
                    <div style="font-size: 12px; color: ${theme.textMuted};">Restart to install the update</div>
                  </div>
                  <button id="installUpdateBtn" style="padding: 8px 16px; background: #22c55e; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 12px; font-weight: 500;">Restart & Install</button>
                </div>
              ` : `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="font-size: 13px; font-weight: 500;">Current Version</div>
                    <div style="font-size: 12px; color: ${theme.textMuted};">v${state.appVersion}</div>
                  </div>
                  <button id="checkUpdatesBtn" style="padding: 8px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 6px; color: ${theme.text}; cursor: pointer; font-size: 12px; font-weight: 500;">${state.updateStatus === 'checking' ? 'Checking...' : 'Check for Updates'}</button>
                </div>
              `}
            </div>
          </div>

          <!-- Danger Zone -->
          <div style="margin-bottom: 40px;">
            <div style="font-size: 11px; color: ${theme.danger}; text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 14px; font-weight: 600;">Danger Zone</div>
            <div style="padding: 20px; background: ${theme.danger}08; border-radius: 12px; border: 1px solid ${theme.danger}20;">
              <div style="font-weight: 500; margin-bottom: 4px;">Reset Vault</div>
              <div style="font-size: 12px; color: ${theme.textMuted}; margin-bottom: 14px;">Permanently delete all data. This action cannot be undone.</div>
              <button id="resetBtn" style="padding: 10px 20px; background: ${theme.danger}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Reset Everything</button>
            </div>
          </div>
        </div>
      </div>
    `;

    const renderModal = (theme) => {
      if (state.showModal === 'newFolder') {
        return `
          <div class="modal-overlay" role="dialog" aria-modal="true" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200;">
            <div style="background: ${theme.surface}; padding: 24px; border-radius: 12px; min-width: 320px; border: 1px solid ${theme.border};">
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">New Folder</div>
              <input type="text" id="folderNameInput" placeholder="Folder name" value="${escapeHtml(state.modalData.name || '')}" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; margin-bottom: 16px;" autofocus />
              <div style="display: flex; gap: 8px;">
                <button id="cancelModalBtn" style="flex: 1; padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Cancel</button>
                <button id="confirmFolderBtn" style="flex: 1; padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Create</button>
              </div>
            </div>
          </div>
        `;
      }
      if (state.showModal === 'changePassword') {
        return `
          <div class="modal-overlay" role="dialog" aria-modal="true" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200;">
            <div style="background: ${theme.surface}; padding: 24px; border-radius: 12px; min-width: 360px; border: 1px solid ${theme.border};">
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">Change Master Password</div>
              <input type="password" id="currentPassInput" placeholder="Current password" autocomplete="current-password" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; margin-bottom: 12px;" autofocus />
              <input type="password" id="newPassInput" placeholder="New password" autocomplete="new-password" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; margin-bottom: 12px;" />
              <input type="password" id="confirmNewPassInput" placeholder="Confirm new password" autocomplete="new-password" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; margin-bottom: 16px;" />
              <div id="passwordError" style="display: none; padding: 10px 14px; background: ${theme.danger}15; border-radius: 8px; color: ${theme.danger}; font-size: 13px; margin-bottom: 16px;"></div>
              <div style="display: flex; gap: 8px;">
                <button id="cancelModalBtn" style="flex: 1; padding: 9px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Cancel</button>
                <button id="confirmPasswordBtn" style="flex: 1; padding: 9px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Change</button>
              </div>
            </div>
          </div>
        `;
      }
      if (state.showModal === 'exportVault') {
        return `
          <div class="modal-overlay" role="dialog" aria-modal="true" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200;">
            <div style="background: ${theme.surface}; padding: 24px; border-radius: 12px; min-width: 380px; border: 1px solid ${theme.border};">
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Export Vault</div>
              <div style="font-size: 13px; color: ${theme.textMuted}; margin-bottom: 20px;">Create a backup of your vault data</div>

              <label style="display: flex; align-items: center; gap: 12px; padding: 14px; background: ${theme.elevated}; border-radius: 8px; cursor: pointer; margin-bottom: 16px;">
                <input type="checkbox" id="encryptExportCheck" style="accent-color: ${theme.accent}; width: 18px; height: 18px;" />
                <div>
                  <div style="font-weight: 500;">Encrypt backup</div>
                  <div style="font-size: 12px; color: ${theme.textMuted};">Protect with a separate password</div>
                </div>
              </label>

              <div id="exportPasswordFields" style="display: none;">
                <input type="password" id="exportPassInput" placeholder="Backup password" autocomplete="new-password" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; margin-bottom: 12px;" />
                <input type="password" id="exportPassConfirmInput" placeholder="Confirm password" autocomplete="new-password" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; margin-bottom: 16px;" />
              </div>

              <div style="display: flex; gap: 8px;">
                <button id="cancelModalBtn" style="flex: 1; padding: 10px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Cancel</button>
                <button id="confirmExportBtn" style="flex: 1; padding: 10px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Export</button>
              </div>
            </div>
          </div>
        `;
      }
      if (state.showModal === 'importPassword') {
        return `
          <div class="modal-overlay" role="dialog" aria-modal="true" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200;">
            <div style="background: ${theme.surface}; padding: 24px; border-radius: 12px; min-width: 360px; border: 1px solid ${theme.border};">
              <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Encrypted Backup</div>
              <div style="font-size: 13px; color: ${theme.textMuted}; margin-bottom: 20px;">Enter the password used to encrypt this backup</div>
              <input type="password" id="importPassInput" placeholder="Backup password" autocomplete="off" style="width: 100%; padding: 11px 14px; background: ${theme.surfaceAlt}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; font-size: 14px; margin-bottom: 16px;" autofocus />
              <div style="display: flex; gap: 8px;">
                <button id="cancelModalBtn" style="flex: 1; padding: 10px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">Cancel</button>
                <button id="confirmImportBtn" style="flex: 1; padding: 10px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500;">Decrypt & Import</button>
              </div>
            </div>
          </div>
        `;
      }
      if (state.showModal === 'auditLog') {
        const severityColors = {
          info: theme.accent,
          warning: '#f59e0b',
          critical: theme.danger
        };
        const entries = state.modalData?.entries || [];
        return `
          <div class="modal-overlay" role="dialog" aria-modal="true" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200;">
            <div style="background: ${theme.surface}; padding: 24px; border-radius: 12px; min-width: 700px; max-width: 90vw; max-height: 80vh; border: 1px solid ${theme.border}; display: flex; flex-direction: column;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div>
                  <div style="font-size: 18px; font-weight: 600;">Security Audit Log</div>
                  <div style="font-size: 12px; color: ${theme.textMuted}; margin-top: 4px;">${entries.length} event${entries.length !== 1 ? 's' : ''} recorded</div>
                </div>
                <button id="cancelModalBtn" style="background: none; border: none; color: ${theme.textMuted}; cursor: pointer; font-size: 24px;">&times;</button>
              </div>

              <div style="flex: 1; overflow-y: auto; margin-bottom: 16px;">
                ${entries.length === 0 ? `
                  <div style="text-align: center; padding: 60px 20px; color: ${theme.textMuted};">
                    <div style="font-size: 48px; margin-bottom: 16px;"></div>
                    <div style="font-size: 14px;">No audit log entries yet</div>
                  </div>
                ` : entries.map(entry => `
                  <div style="padding: 14px; background: ${theme.elevated}; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid ${severityColors[entry.severity] || theme.accent};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                      <div style="flex: 1;">
                        <div style="font-weight: 500; font-size: 13px; margin-bottom: 4px;">${escapeHtml(entry.event)}</div>
                        <div style="font-size: 11px; color: ${theme.textMuted};">
                          ${new Date(entry.timestamp).toLocaleString()}
                        </div>
                      </div>
                      <div style="padding: 2px 8px; background: ${severityColors[entry.severity]}20; border-radius: 4px; font-size: 10px; font-weight: 600; color: ${severityColors[entry.severity]}; text-transform: uppercase;">
                        ${entry.severity}
                      </div>
                    </div>
                    ${Object.keys(entry.details || {}).length > 0 ? `
                      <div style="font-size: 11px; color: ${theme.textFaint}; font-family: monospace; background: ${theme.surface}; padding: 8px; border-radius: 4px; overflow-x: auto;">
                        ${Object.entries(entry.details).filter(([k,v]) => k !== 'timestamp').map(([k,v]) => `
                          <span style="color: ${theme.textMuted};">${escapeHtml(k)}:</span> ${escapeHtml(String(v))}<br/>
                        `).join('')}
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              </div>

              <div style="padding-top: 12px; border-top: 1px solid ${theme.border}; font-size: 11px; color: ${theme.textFaint};">
                All audit log data is encrypted with your vault key and stored locally
              </div>
            </div>
          </div>
        `;
      }
      return '';
    };

    const renderTemplatesModal = (theme) => `
      <div class="modal-overlay" role="dialog" aria-modal="true" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200;">
        <div style="background: ${theme.surface}; padding: 24px; border-radius: 12px; min-width: 400px; border: 1px solid ${theme.border};">
          <div style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">Choose Template</div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
            ${templates.map(t => `
              <button class="template-btn" data-template="${t.id}" style="padding: 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 10px; cursor: pointer; text-align: left; color: ${theme.text};">
                <div style="font-size: 24px; margin-bottom: 8px;">${t.icon}</div>
                <div style="font-weight: 500;">${t.name}</div>
              </button>
            `).join('')}
          </div>
        </div>
      </div>
    `;

    const renderVersionsModal = (theme, selected) => `
      <div class="modal-overlay" role="dialog" aria-modal="true" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200;">
        <div style="background: ${theme.surface}; padding: 24px; border-radius: 12px; min-width: 400px; max-height: 80vh; overflow: auto; border: 1px solid ${theme.border};">
          <div style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">Version History</div>
          ${selected.versions.length === 0 ? `<p style="color: ${theme.textMuted};">No previous versions</p>` : `
            <div style="max-height: 400px; overflow: auto;">
              ${[...selected.versions].reverse().map((v, idx) => `
                <div style="padding: 12px; background: ${theme.elevated}; border-radius: 8px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 12px; color: ${theme.textMuted};">${formatFullDate(v.timestamp)}</span>
                    <button class="restore-version-btn" data-index="${selected.versions.length - 1 - idx}" style="padding: 4px 10px; background: ${theme.surface}; border: 1px solid ${theme.border}; border-radius: 6px; color: ${theme.text}; cursor: pointer; font-size: 11px;">Restore</button>
                  </div>
                  <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">${escapeHtml(v.title) || 'Untitled'}</div>
                  <div style="font-size: 12px; color: ${theme.textMuted}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(v.content?.slice(0, 100)) || 'Empty'}</div>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      </div>
    `;

    const renderQrScannerModal = (theme) => `
      <div class="modal-overlay" role="dialog" aria-modal="true" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 200;">
        <div style="background: ${theme.surface}; padding: 24px; border-radius: 12px; min-width: 400px; border: 1px solid ${theme.border};">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="font-size: 18px; font-weight: 600;">Add 2FA Account</div>
            <button id="closeQrScannerBtn" style="background: none; border: none; color: ${theme.textMuted}; cursor: pointer; font-size: 20px;">&times;</button>
          </div>

          <div style="text-align: center; padding: 20px; background: ${theme.surfaceAlt}; border-radius: 10px; margin-bottom: 16px;">
            <div style="font-size: 24px; margin-bottom: 12px; font-weight: bold;">SCAN QR</div>
            <div style="font-size: 14px; color: ${theme.textMuted}; margin-bottom: 16px;">
              Scan a QR code or paste the secret key
            </div>
          </div>

          <div style="display: flex; flex-direction: column; gap: 10px;">
            <label style="padding: 12px 16px; background: ${theme.accent}; border: none; border-radius: 8px; color: #fff; cursor: pointer; font-size: 13px; font-weight: 500; text-align: center;">
               Upload QR Code Image
              <input type="file" id="qrImageInput" accept="image/*" style="display: none;" />
            </label>

            <button id="pasteUriBtn" style="padding: 12px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">
               Paste otpauth:// URI
            </button>

            <button id="manualEntryBtn" style="padding: 12px 16px; background: ${theme.elevated}; border: 1px solid ${theme.border}; border-radius: 8px; color: ${theme.text}; cursor: pointer; font-size: 13px; font-weight: 500;">
              Edit Enter Manually
            </button>
          </div>

          <div style="margin-top: 16px; padding: 12px; background: ${theme.surfaceAlt}; border-radius: 8px;">
            <div style="font-size: 11px; color: ${theme.textMuted}; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Quick Guide</div>
            <div style="font-size: 12px; color: ${theme.textFaint}; line-height: 1.5;">
              1. Open your authenticator app setup<br>
              2. Look for "Can't scan?" or "Manual entry"<br>
              3. Copy the secret key or otpauth:// URI<br>
              4. Paste it here using the button above
            </div>
          </div>
        </div>
      </div>
    `;

    // ============ EVENT HANDLERS ============
    const attachLockScreenEvents = () => {
      const unlockBtn = document.getElementById('unlockBtn');
      const passInput = document.getElementById('passInput');
      const passConfirm = document.getElementById('passConfirm');
      const passError = document.getElementById('passError');

      const showError = (msg) => {
        passError.textContent = msg;
        passError.style.display = 'block';
      };

      unlockBtn?.addEventListener('click', async () => {
        const pass = passInput.value;
        if (state.setupMode) {
          if (pass !== passConfirm?.value) { showError('Passwords do not match'); return; }

          try {
            const result = await setup(pass);
            if (result === false) {
              showError('Failed to create vault');
            }
          } catch (err) {
            showError('Failed to create vault');
          }
        } else {
          if (!await unlock(pass)) { showError('Incorrect password'); }
        }
      });

      passInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          if (state.setupMode && passConfirm) passConfirm.focus();
          else unlockBtn?.click();
        }
      });

      passConfirm?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') unlockBtn?.click();
      });

      // Window controls for lock screen
      document.getElementById('minimizeBtn')?.addEventListener('click', () => {
        window.windowControls?.minimize();
      });
      document.getElementById('maximizeBtn')?.addEventListener('click', () => {
        window.windowControls?.maximize();
      });
      document.getElementById('closeBtn')?.addEventListener('click', () => {
        window.windowControls?.close();
      });

      // Reset vault button for permanent lock screen
      document.getElementById('resetVaultBtn')?.addEventListener('click', async () => {
        showConfirm(
          'Reset Vault',
          'This will permanently delete ALL your data including passwords, notes, files, and 2FA codes. This action CANNOT be undone. Are you absolutely sure?',
          async () => {
            try {
              const result = await window.vault.reset();
              if (result.success) {
                // Clear frontend state
                state.permanentlyLocked = false;
                state.lockoutLevel = null;
                state.failedAttempts = 0;
                state.lockoutUntil = 0;
                state.setupMode = true;
                state.locked = true;
                state.data = { ...defaultData };
                render();
                showToast('Vault reset successfully. Create a new password to start fresh.', 'success');
              } else {
                showToast('Failed to reset vault: ' + (result.error || 'Unknown error'), 'error');
              }
            } catch (err) {
              console.error('Vault reset failed:', err);
              showToast('Failed to reset vault', 'error');
            }
          },
          'danger'
        );
      });
    };

    const attachMainAppEvents = () => {
      // Clean up previous document-level listeners to prevent memory leaks
      cleanupDocumentListeners();

      // Activity tracking
      addDocumentListener('click', resetActivityTimer);
      addDocumentListener('keydown', resetActivityTimer);

      // Hide context menu on click (tracked to prevent accumulation)
      addDocumentListener('click', contextMenuClickHandler);

      // Navigation
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.section = btn.dataset.section;
          state.selectedId = null;
          state.search = '';
          state.selectedFolder = null;
          state.selectedFiles = [];
          state.showTrash = false;
          state.showGen = false;
          render();
        });
      });

      document.getElementById('lockBtn')?.addEventListener('click', lock);

      // Window controls
      document.getElementById('minimizeBtn')?.addEventListener('click', () => {
        window.windowControls?.minimize();
      });
      document.getElementById('maximizeBtn')?.addEventListener('click', () => {
        window.windowControls?.maximize();
      });
      document.getElementById('closeBtn')?.addEventListener('click', () => {
        window.windowControls?.close();
      });

      // Search filter toggle
      document.getElementById('searchFilterBtn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        state.showSearchFilters = !state.showSearchFilters;
        render();
      });

      // Search filter options
      document.querySelectorAll('input[name="searchFilter"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          state.searchFilter = e.target.value;
          state.showSearchFilters = false;
          render();
        });
      });

      // Close search filters on outside click
      if (state.showSearchFilters) {
        document.addEventListener('click', function closeFilters(e) {
          if (!e.target.closest('.search-container')) {
            state.showSearchFilters = false;
            render();
            document.removeEventListener('click', closeFilters);
          }
        });
      }

      // Search - debounced to prevent lag on every keystroke
      const debouncedSearch = debounce(() => {
        const listContainer = document.querySelector('[style*="overflow: auto"][style*="padding: 12px"]');
        if (listContainer) {
          const items = getSortedFiltered();
          const theme = getTheme();
          listContainer.innerHTML = items.length === 0
            ? `<div style="padding: 32px; text-align: center; color: ${theme.textFaint}; font-size: 13px;">${state.search ? 'No results' : 'Nothing here yet'}</div>`
            : items.map(item => renderListItem(theme, item, getSelected())).join('');
          attachListItemEvents();
        }
      }, 150); // 150ms debounce for responsive feel

      document.getElementById('searchInput')?.addEventListener('input', (e) => {
        state.search = e.target.value;
        debouncedSearch();
      });

      attachListItemEvents();
      attachDetailEvents();
      attachModalEvents();
      attachSettingsEvents();
    };

    // Shared handler for context menu hiding (created once to avoid recreating on each call)
    const contextMenuClickHandler = () => hideContextMenu();

    const attachListItemEvents = () => {
      // Hide context menu on click - use tracked listener (only added once in attachMainAppEvents)
      // Don't add here since attachListItemEvents is called multiple times

      // List items with drag and drop and context menu
      document.querySelectorAll('.list-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (!e.target.classList.contains('file-checkbox')) {
            state.selectedId = item.dataset.id;
            render();
          }
        });

        // Right-click context menu
        item.addEventListener('contextmenu', (e) => {
          const itemData = getItems().find(i => i.id === item.dataset.id);
          if (itemData) showContextMenu(e, itemData, state.section);
        });

        item.addEventListener('dragstart', (e) => {
          const itemData = getItems().find(i => i.id === item.dataset.id);
          if (itemData) handleDragStart(e, itemData);
        });

        item.addEventListener('dragend', handleDragEnd);

        item.addEventListener('dragover', (e) => {
          const itemData = getItems().find(i => i.id === item.dataset.id);
          if (itemData) handleDragOver(e, itemData);
        });

        item.addEventListener('dragleave', handleDragLeave);

        item.addEventListener('drop', (e) => {
          const itemData = getItems().find(i => i.id === item.dataset.id);
          if (itemData) handleDrop(e, itemData);
        });
      });

      // Folders with drag-drop support
      document.querySelectorAll('.folder-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-folder-btn')) {
            state.selectedFolder = item.dataset.folder || null;
            state.selectedId = null;
            render();
          }
        });

        // Drag into folder
        item.addEventListener('dragover', (e) => handleFolderDragOver(e, item.dataset.folder));
        item.addEventListener('dragleave', handleFolderDragLeave);
        item.addEventListener('drop', (e) => handleFolderDrop(e, item.dataset.folder || null));
      });

      document.querySelectorAll('.delete-folder-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteFolder(btn.dataset.folder, state.section);
        });
      });

      // New buttons
      document.getElementById('newFolderBtn')?.addEventListener('click', () => {
        state.showModal = 'newFolder';
        state.modalData = {};
        render();
      });

      document.getElementById('newEntryBtn')?.addEventListener('click', () => { state.showTemplates = true; render(); });
      document.getElementById('newEntryBtnEmpty')?.addEventListener('click', () => { state.showTemplates = true; render(); });
      document.getElementById('newPassBtn')?.addEventListener('click', () => createPassword());
      document.getElementById('newPassBtnEmpty')?.addEventListener('click', () => createPassword());
      document.getElementById('newTotpBtn')?.addEventListener('click', createTotp);
      document.getElementById('newTotpBtnEmpty')?.addEventListener('click', createTotp);
      document.getElementById('scanQrBtn')?.addEventListener('click', openQrScanner);

      // Notes
      document.getElementById('newNoteBtn')?.addEventListener('click', createNote);
      document.getElementById('newNoteBtnEmpty')?.addEventListener('click', createNote);

      // Private lock
      document.getElementById('unlockPrivateBtn')?.addEventListener('click', () => {
        if (state.data.privatePasswordHash) {
          unlockPrivate();
        } else {
          setupPrivatePassword();
        }
      });
      document.getElementById('resetPrivateBtn')?.addEventListener('click', resetPrivateSection);
      document.getElementById('lockPrivateBtn')?.addEventListener('click', () => {
        state.privateLocked = true;
        state.privateKey = '';
        state.selectedId = null;
        render();
        showToast('Private section locked', 'success');
      });
      document.getElementById('privatePasswordInput')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          if (state.data.privatePasswordHash) {
            unlockPrivate();
          } else {
            document.getElementById('privatePasswordConfirm')?.focus();
          }
        }
      });
      document.getElementById('privatePasswordConfirm')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') setupPrivatePassword();
      });

      document.getElementById('genToggleBtn')?.addEventListener('click', () => { state.showGen = !state.showGen; render(); });

      // File upload
      document.getElementById('uploadBtn')?.addEventListener('click', () => document.getElementById('fileInput')?.click());
      document.getElementById('uploadBtnEmpty')?.addEventListener('click', () => document.getElementById('fileInput')?.click());
      document.getElementById('fileInput')?.addEventListener('change', (e) => {
        if (e.target.files) processFiles(e.target.files);
        e.target.value = '';
      });

      // Trash
      document.querySelectorAll('.trash-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          state.showTrash = btn.dataset.show === 'true';
          state.selectedFolder = null;
          state.selectedId = null;
          render();
        });
      });

      document.getElementById('emptyTrashBtn')?.addEventListener('click', emptyTrash);

      // Password generator
      document.getElementById('genLenSlider')?.addEventListener('input', (e) => {
        state.genLen = parseInt(e.target.value, 10);
        document.querySelector('[style*="min-width: 24px"]').textContent = state.genLen;
      });

      document.querySelectorAll('.gen-opt-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.genOpts[btn.dataset.opt] = !state.genOpts[btn.dataset.opt];
          render();
        });
      });

      document.getElementById('doGenerateBtn')?.addEventListener('click', doGenerate);
      document.getElementById('copyGenBtn')?.addEventListener('click', () => copyText(state.genResult));
      document.getElementById('useGenBtn')?.addEventListener('click', () => createPassword(state.genResult));

      // File drop zone (empty state)
      const dropZone = document.getElementById('fileDropZone');
      if (dropZone && state.section === 'files' && !state.showTrash) {
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = getTheme().accent + '10'; });
        dropZone.addEventListener('dragleave', () => { dropZone.style.background = ''; });
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.style.background = '';
          if (e.dataTransfer.files?.length > 0) processFiles(e.dataTransfer.files);
        });
      }

      // File drop zone (detail view)
      const fileDetailDropZone = document.getElementById('fileDetailDropZone');
      if (fileDetailDropZone && state.section === 'files' && !state.showTrash) {
        fileDetailDropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.stopPropagation();
          fileDetailDropZone.style.outline = '2px dashed ' + getTheme().accent;
          fileDetailDropZone.style.outlineOffset = '-8px';
          fileDetailDropZone.style.background = getTheme().accent + '08';
        });
        fileDetailDropZone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          e.stopPropagation();
          fileDetailDropZone.style.outline = '';
          fileDetailDropZone.style.outlineOffset = '';
          fileDetailDropZone.style.background = '';
        });
        fileDetailDropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          fileDetailDropZone.style.outline = '';
          fileDetailDropZone.style.outlineOffset = '';
          fileDetailDropZone.style.background = '';
          if (e.dataTransfer.files?.length > 0) {
            processFiles(e.dataTransfer.files);
            showToast(`Uploading ${e.dataTransfer.files.length} file(s)...`, 'success');
          }
        });
      }
    };

    const attachDetailEvents = () => {
      const selected = getSelected();

      // Delete
      document.getElementById('deleteItemBtn')?.addEventListener('click', () => {
        if (state.selectedId) removeItem(state.selectedId);
      });

      // Debounced content updates to prevent excessive saves and history spam
      const debouncedContentUpdate = debounce((id, changes) => {
        updateItem(id, changes);
      }, 300);

      // Debounced update for password fields
      const debouncedPassFieldUpdate = debounce((id, key, value) => {
        updateItem(id, { [key]: value });
      }, 300);

      // Debounced update for notes input
      const debouncedNotesUpdate = debounce((id, value) => {
        updateItem(id, { notes: value });
      }, 300);

      // Debounced update for TOTP fields
      const debouncedTotpUpdate = debounce((id, changes) => {
        updateItem(id, changes);
      }, 300);

      // Debounced update for note items
      const debouncedNoteItemUpdate = debounce((id, changes) => {
        updateItem(id, changes);
      }, 300);

      document.querySelectorAll('.edit-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => { state.editMode = btn.dataset.mode; render(); });
      });

      document.getElementById('titleInput')?.addEventListener('input', (e) => {
        // Immediate local update for responsive feel, debounced save
        const item = getItems().find(i => i.id === state.selectedId);
        if (item) item.title = e.target.value;
        debouncedContentUpdate(state.selectedId, { title: e.target.value });
      });

      document.getElementById('contentInput')?.addEventListener('input', (e) => {
        // Immediate local update for responsive feel, debounced save
        const item = getItems().find(i => i.id === state.selectedId);
        if (item) item.content = e.target.value;
        debouncedContentUpdate(state.selectedId, { content: e.target.value });
      });

      document.getElementById('pinBtn')?.addEventListener('click', () => {
        if (selected) updateItem(selected.id, { pinned: !selected.pinned }, true);
        render();
      });

      document.getElementById('historyBtn')?.addEventListener('click', () => { state.showVersions = true; render(); });

      document.getElementById('addImageBtn')?.addEventListener('click', () => document.getElementById('imageInput')?.click());
      document.getElementById('imageInput')?.addEventListener('change', (e) => {
        if (e.target.files) processFiles(e.target.files, true);
        e.target.value = '';
      });

      document.querySelectorAll('.remove-image-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const imageId = btn.dataset.image;
          state.data.journal = state.data.journal.map(j =>
            j.id === state.selectedId ? { ...j, images: (j.images || []).filter(img => img.id !== imageId) } : j
          );
          render();
          saveData();
        });
      });

      // Passwords - debounced to prevent excessive saves
      document.querySelectorAll('.pass-field').forEach(input => {
        input.addEventListener('input', () => {
          debouncedPassFieldUpdate(state.selectedId, input.dataset.key, input.value);
        });
      });

      document.getElementById('notesInput')?.addEventListener('input', (e) => {
        debouncedNotesUpdate(state.selectedId, e.target.value);
      });

      document.querySelectorAll('.toggle-pass-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.showPass[state.selectedId] = !state.showPass[state.selectedId];
          render();
        });
      });

      document.querySelectorAll('.copy-field-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (selected) {
            copyText(selected[btn.dataset.key]);
            showSaveIndicator(btn.dataset.key === 'password' ? 'Password copied' : 'Copied');
          }
        });
      });

      // Open URL button
      document.getElementById('openUrlBtn')?.addEventListener('click', async () => {
        if (selected?.url) {
          let url = selected.url;
          if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'https://' + url;
          }
          // Open in user's default browser
          const result = await window.appInfo.openExternal(url);
          if (result && !result.success) {
            showToast('Failed to open URL', 'error');
          }
        }
      });

      // TOTP - debounced saves
      document.getElementById('totpIssuer')?.addEventListener('input', (e) => {
        debouncedTotpUpdate(state.selectedId, { issuer: e.target.value });
      });

      document.getElementById('totpAccount')?.addEventListener('input', (e) => {
        debouncedTotpUpdate(state.selectedId, { account: e.target.value });
      });

      document.getElementById('totpSecret')?.addEventListener('input', async (e) => {
        const secret = e.target.value.toUpperCase().replace(/[^A-Z2-7]/g, '');
        debouncedTotpUpdate(state.selectedId, { secret });
        // Generate code immediately for feedback
        if (secret.length >= 16) {
          const code = await TOTP.generate(secret);
          if (code) {
            state.totpCodes[state.selectedId] = code;
            const codeDisplay = document.querySelector(`.totp-code-display[data-id="${state.selectedId}"]`);
            if (codeDisplay) codeDisplay.textContent = code;
          }
        }
      });

      document.getElementById('copyTotpBtn')?.addEventListener('click', () => {
        if (state.totpCodes[state.selectedId]) {
          copyText(state.totpCodes[state.selectedId]);
          showSaveIndicator('Code copied');
        }
      });

      // Notes - debounced saves
      document.getElementById('noteTitleInput')?.addEventListener('input', (e) => {
        debouncedNoteItemUpdate(state.selectedId, { title: e.target.value });
      });

      document.getElementById('noteContentInput')?.addEventListener('input', (e) => {
        debouncedNoteItemUpdate(state.selectedId, { content: e.target.value });
      });

      document.getElementById('pinNoteBtn')?.addEventListener('click', () => {
        const selected = getSelected();
        if (selected) {
          updateItem(selected.id, { pinned: !selected.pinned });
          render();
        }
      });

      // Files
      document.getElementById('downloadBtn')?.addEventListener('click', async () => {
        if (selected) await downloadFile(selected);
      });

      document.getElementById('restoreBtn')?.addEventListener('click', () => {
        if (state.selectedId) restoreFromTrash(state.selectedId);
      });

      document.getElementById('permDeleteBtn')?.addEventListener('click', () => {
        if (state.selectedId) permanentDelete(state.selectedId);
      });
    };

    const attachModalEvents = () => {
      document.querySelector('.modal-overlay')?.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
          state.showModal = null;
          state.modalData = {};
          state.showTemplates = false;
          state.showVersions = false;
          state.showQrScanner = false;
          render();
        }
      });

      // QR Scanner modal events
      document.getElementById('closeQrScannerBtn')?.addEventListener('click', closeQrScanner);
      document.getElementById('pasteUriBtn')?.addEventListener('click', handlePasteOtpUri);
      document.getElementById('manualEntryBtn')?.addEventListener('click', () => {
        closeQrScanner();
        createTotp();
      });
      document.getElementById('qrImageInput')?.addEventListener('change', (e) => {
        if (e.target.files?.[0]) handleQrImageUpload(e.target.files[0]);
      });

      document.getElementById('cancelModalBtn')?.addEventListener('click', () => {
        state.showModal = null;
        state.modalData = {};
        render();
      });

      document.getElementById('folderNameInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') createFolder(state.section, e.target.value);
      });

      document.getElementById('confirmFolderBtn')?.addEventListener('click', () => {
        const input = document.getElementById('folderNameInput');
        if (input) createFolder(state.section, input.value);
      });

      document.getElementById('confirmPasswordBtn')?.addEventListener('click', async () => {
        const currentPass = document.getElementById('currentPassInput')?.value;
        const newPass = document.getElementById('newPassInput')?.value;
        const confirmPass = document.getElementById('confirmNewPassInput')?.value;
        const errorEl = document.getElementById('passwordError');

        if (!currentPass || !newPass || !confirmPass) {
          if (errorEl) { errorEl.textContent = 'All fields are required'; errorEl.style.display = 'block'; }
          return;
        }

        if (newPass !== confirmPass) {
          if (errorEl) { errorEl.textContent = 'New passwords do not match'; errorEl.style.display = 'block'; }
          return;
        }

        // Use backend vault to change master password
        const result = await window.vault.changeMasterPassword(currentPass, newPass);

        if (!result.success) {
          if (errorEl) {
            errorEl.textContent = result.error || 'Failed to change password';
            errorEl.style.display = 'block';
          }
          return;
        }

        state.showModal = null;
        state.modalData = {};
        render();
        showToast('Master password changed successfully', 'success');
      });

      document.querySelectorAll('.template-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const template = templates.find(t => t.id === btn.dataset.template);
          createJournal(template);
        });
      });

      document.querySelectorAll('.restore-version-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const selected = getSelected();
          const index = parseInt(btn.dataset.index, 10);

          if (!selected?.versions || isNaN(index) || index < 0 || index >= selected.versions.length) {
            showToast('Failed to restore version - invalid selection', 'error');
            return;
          }

          const version = selected.versions[index];
          if (version) {
            updateItem(selected.id, { content: version.content, title: version.title });
            state.showVersions = false;
            render();
            showToast('Version restored', 'success');
          } else {
            showToast('Failed to restore version', 'error');
          }
        });
      });

      // Export modal events
      document.getElementById('encryptExportCheck')?.addEventListener('change', (e) => {
        const fields = document.getElementById('exportPasswordFields');
        if (fields) {
          fields.style.display = e.target.checked ? 'block' : 'none';
        }
      });

      document.getElementById('confirmExportBtn')?.addEventListener('click', () => {
        const encrypt = document.getElementById('encryptExportCheck')?.checked;
        const pass = document.getElementById('exportPassInput')?.value;
        const confirmPass = document.getElementById('exportPassConfirmInput')?.value;

        if (encrypt) {
          if (!pass || pass.length < 4) {
            showToast('Password must be at least 4 characters', 'error');
            return;
          }
          if (pass !== confirmPass) {
            showToast('Passwords do not match', 'error');
            return;
          }
        }

        doExport(encrypt, pass);
      });

      // Import password modal events
      document.getElementById('confirmImportBtn')?.addEventListener('click', () => {
        const pass = document.getElementById('importPassInput')?.value;
        if (!pass) {
          showToast('Please enter the backup password', 'error');
          return;
        }
        doImportEncrypted(state.modalData.backup, pass);
      });

      document.getElementById('importPassInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const pass = e.target.value;
          if (pass) doImportEncrypted(state.modalData.backup, pass);
        }
      });
    };

    const attachSettingsEvents = () => {
      // Debounced settings update for sliders
      const debouncedFontSizeUpdate = debounce((value) => {
        updateSettings('fontSize', value);
      }, 150);

      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          updateSettings('theme', btn.dataset.theme);
          showToast('Theme changed', 'success');
        });
      });

      document.getElementById('autoLockSelect')?.addEventListener('change', (e) => {
        const val = parseInt(e.target.value, 10);
        updateSettings('autoLockMinutes', val);
        showToast(val === 0 ? 'Auto-lock disabled' : `Auto-lock set to ${val} minute${val > 1 ? 's' : ''}`, 'success');
      });

      document.getElementById('maxAttemptsSelect')?.addEventListener('change', (e) => {
        const val = parseInt(e.target.value, 10);
        updateSettings('maxLoginAttempts', val);
        showToast(`Max login attempts set to ${val}`, 'success');
      });

      document.getElementById('fontSizeSlider')?.addEventListener('input', (e) => {
        const value = parseInt(e.target.value, 10);
        // Apply font size immediately for responsive feel
        document.body.style.fontSize = value + 'px';
        const display = e.target.parentElement?.querySelector('span:last-child');
        if (display) display.textContent = value + 'px';
        // Debounce the save
        debouncedFontSizeUpdate(value);
      });

      document.getElementById('fontSizeSlider')?.addEventListener('change', (e) => {
        showToast(`Font size set to ${e.target.value}px`, 'success');
      });

      document.getElementById('defaultSectionSelect')?.addEventListener('change', (e) => {
        updateSettings('defaultSection', e.target.value);
        const names = { journal: 'Journal', passwords: 'Passwords', totp: '2FA Codes', notes: 'Private', files: 'Files' };
        showToast(`Default section set to ${names[e.target.value] || e.target.value}`, 'success');
      });

      document.getElementById('sortOrderSelect')?.addEventListener('change', (e) => {
        updateSettings('sortOrder', e.target.value);
        const names = { newest: 'Newest First', oldest: 'Oldest First', alpha: 'Alphabetical', modified: 'Recently Modified' };
        showToast(`Sort order set to ${names[e.target.value] || e.target.value}`, 'success');
      });

      document.getElementById('encryptFilesCheck')?.addEventListener('change', (e) => {
        updateSettings('encryptFiles', e.target.checked);
        showToast(e.target.checked ? 'File encryption enabled' : 'File encryption disabled', 'success');
      });

      document.getElementById('maxFileSizeSelect')?.addEventListener('change', (e) => {
        updateSettings('maxFileSizeMB', parseInt(e.target.value, 10));
        showToast(`Max file size set to ${e.target.value} MB`, 'success');
      });

      document.getElementById('maxVaultSizeSelect')?.addEventListener('change', (e) => {
        const value = parseInt(e.target.value, 10);
        updateSettings('maxVaultSizeMB', value);
        showToast(`Max vault size set to ${value >= 1000 ? (value / 1000) + ' GB' : value + ' MB'}`, 'success');
      });

      document.getElementById('enableVersioningCheck')?.addEventListener('change', (e) => {
        updateSettings('enableVersioning', e.target.checked);
        showToast(e.target.checked ? 'Version history enabled' : 'Version history disabled', 'success');
      });

      document.getElementById('compactViewCheck')?.addEventListener('change', (e) => {
        const isChecked = e.target.checked;
        updateSettings('compactView', isChecked);
        showToast(isChecked ? 'Compact view enabled' : 'Compact view disabled', 'success');
      });

      document.getElementById('clearClipboardCheck')?.addEventListener('change', (e) => {
        updateSettings('clearClipboard', e.target.checked);
        showToast(e.target.checked ? 'Auto-clear clipboard enabled' : 'Auto-clear clipboard disabled', 'success');
      });

      document.getElementById('showStrengthCheck')?.addEventListener('change', (e) => {
        updateSettings('showPasswordStrength', e.target.checked);
        showToast(e.target.checked ? 'Password strength indicator enabled' : 'Password strength indicator disabled', 'success');
      });

      document.getElementById('confirmDeleteCheck')?.addEventListener('change', (e) => {
        updateSettings('confirmDelete', e.target.checked);
        showToast(e.target.checked ? 'Delete confirmation enabled' : 'Delete confirmation disabled', 'success');
      });

      document.getElementById('exportBtn')?.addEventListener('click', exportData);

      document.getElementById('importInput')?.addEventListener('change', (e) => {
        if (e.target.files?.[0]) importData(e.target.files[0]);
        e.target.value = '';
      });

      document.getElementById('changePasswordBtn')?.addEventListener('click', () => {
        state.showModal = 'changePassword';
        state.modalData = {};
        render();
      });

      document.getElementById('resetBtn')?.addEventListener('click', resetVault);

      // Auto-update toggle
      document.getElementById('autoUpdateCheck')?.addEventListener('change', (e) => {
        updateSettings('autoUpdate', e.target.checked);
        showToast(e.target.checked ? 'Auto-update enabled' : 'Auto-update disabled', 'success');
      });

      // Check for updates button
      document.getElementById('checkUpdatesBtn')?.addEventListener('click', () => {
        if (window.autoUpdater) {
          showToast('Checking for updates...', 'info');
          window.autoUpdater.checkForUpdates();
        } else {
          showToast('Auto-updater not available in dev mode', 'warning');
        }
      });

      // Download update button
      document.getElementById('downloadUpdateBtn')?.addEventListener('click', () => {
        if (window.autoUpdater) {
          window.autoUpdater.downloadUpdate();
        }
      });

      // Install update button
      document.getElementById('installUpdateBtn')?.addEventListener('click', () => {
        if (window.autoUpdater) {
          window.autoUpdater.installUpdate();
        }
      });

      // Audit log buttons
      document.getElementById('viewAuditLogBtn')?.addEventListener('click', viewAuditLog);
      document.getElementById('exportAuditLogBtn')?.addEventListener('click', exportAuditLog);
      document.getElementById('clearAuditLogBtn')?.addEventListener('click', clearAuditLog);
    };

    // ============ AUDIT LOG FUNCTIONS ============
    const viewAuditLog = async () => {
      try {
        const result = await window.auditLog.getEntries({ limit: 100 });
        if (!result.success) {
          showToast('Failed to load audit log', 'error');
          return;
        }

        state.showModal = 'auditLog';
        state.modalData = { entries: result.entries || [] };
        render();
      } catch (err) {
        showToast('Failed to load audit log', 'error');
      }
    };

    const exportAuditLog = async () => {
      try {
        const result = await window.auditLog.export();
        if (!result.success) {
          showToast('Failed to export audit log', 'error');
          return;
        }

        const dateStr = new Date().toISOString().split('T')[0];
        const blob = new Blob([result.data], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `eterna-audit-log-${dateStr}.json`;
        a.click();
        URL.revokeObjectURL(a.href);

        showToast('Audit log exported successfully', 'success');
      } catch (err) {
        showToast('Failed to export audit log', 'error');
      }
    };

    const clearAuditLog = () => {
      showConfirm(
        'Clear Audit Log',
        'Are you sure you want to clear the entire audit log? This action cannot be undone.',
        async () => {
          const result = await window.auditLog.clear();
          if (result.success) {
            showToast('Audit log cleared successfully', 'success');
          } else {
            showToast('Failed to clear audit log', 'error');
          }
        }
      );
    };

    // ============ INIT ============
    const init = async () => {
      try {
        // Get app version
        if (window.appInfo?.getVersion) {
          state.appVersion = await window.appInfo.getVersion();
        }

        // Check if vault has been initialized
        const { initialized } = await window.vault.isInitialized();

        if (!initialized) {
          // First time setup - show setup screen
          state.setupMode = true;
          state.loaded = true;
          render();
          return;
        }

        // Check lockout status from backend
        try {
          const lockoutStatus = await window.vault.getLockoutStatus();
          if (lockoutStatus.isPermanentlyLocked) {
            state.permanentlyLocked = true;
            state.lockoutLevel = lockoutStatus.lockoutLevel;
          } else if (lockoutStatus.isLocked) {
            state.lockoutUntil = Date.now() + (lockoutStatus.remainingSeconds * 1000);
            state.lockoutLevel = lockoutStatus.lockoutLevel;
          }
        } catch (lockoutErr) {
          console.warn('Could not check lockout status:', lockoutErr);
        }

        // Vault exists but is locked - show unlock screen
        state.setupMode = false;
        state.locked = true;
        state.loaded = true;
        render();
      } catch (err) {
        console.error('Init error:', err);
        state.setupMode = true;
        state.loaded = true;
        render();
      }
    };

    init();

    // ============ AUTO-UPDATE LISTENER ============
    if (window.autoUpdater) {
      window.autoUpdater.onUpdateStatus((data) => {
        state.updateStatus = data.status;
        if (data.status === 'available') {
          state.updateVersion = data.version;
          showToast('Update v' + data.version + ' available!', 'info');
        } else if (data.status === 'downloading') {
          state.updatePercent = data.percent;
        } else if (data.status === 'downloaded') {
          showToast('Update downloaded! Restart to install.', 'success');
        } else if (data.status === 'not-available') {
          showToast('You are running the latest version!', 'success');
        } else if (data.status === 'error') {
          showToast('Update check failed: ' + (data.message || 'Unknown error'), 'error');
        }
        render();
      });
    }

    // ============ TRAY LOCK HANDLER ============
    window.windowControls?.onLockVault?.(async () => {
      if (!state.locked) {
        await lock().catch(console.error);
      }
    });

    // ============ KEYBOARD SHORTCUTS ============
    document.addEventListener('keydown', (e) => {
      // Don't trigger shortcuts when typing in input fields
      const isTyping = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName);

      // Global shortcuts (work even when typing)
      if (e.ctrlKey && e.key === 'l') {
        e.preventDefault();
        if (!state.locked) lock().catch(console.error);
        return;
      }

      // Undo - Ctrl+Z
      if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        if (!state.locked) undo();
        return;
      }

      // Redo - Ctrl+Y or Ctrl+Shift+Z
      if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
        e.preventDefault();
        if (!state.locked) redo();
        return;
      }

      // Shortcuts that only work when not typing
      if (!isTyping) {
        // Ctrl+N - New item
        if (e.ctrlKey && e.key === 'n') {
          e.preventDefault();
          if (state.locked) return;
          if (state.section === 'journal') {
            state.showTemplates = true;
            render();
          } else if (state.section === 'passwords') {
            createPassword();
          } else if (state.section === 'totp') {
            createTotp();
          } else if (state.section === 'notes' && !state.privateLocked) {
            createNote();
          }
          return;
        }

        // Ctrl+F - Focus search
        if (e.ctrlKey && e.key === 'f') {
          e.preventDefault();
          const searchInput = document.getElementById('searchInput');
          if (searchInput) {
            searchInput.focus();
            searchInput.select();
          }
          return;
        }

        // Ctrl+1-6 - Switch sections
        if (e.ctrlKey && e.key >= '1' && e.key <= '6') {
          e.preventDefault();
          if (state.locked) return;
          const sections = ['journal', 'notes', 'passwords', 'totp', 'files', 'settings'];
          const index = parseInt(e.key, 10) - 1;
          if (sections[index]) {
            state.section = sections[index];
            state.selectedId = null;
            state.selectedFolder = null;
            state.search = '';
            render();
          }
          return;
        }

        // Escape - Close modals/deselect
        if (e.key === 'Escape') {
          if (state.showModal) {
            state.showModal = null;
            state.modalData = {};
            render();
          } else if (state.showTemplates) {
            state.showTemplates = false;
            render();
          } else if (state.showVersions) {
            state.showVersions = false;
            render();
          } else if (state.showQrScanner) {
            if (state.cameraStream) {
              state.cameraStream.getTracks().forEach(t => t.stop());
              state.cameraStream = null;
            }
            state.showQrScanner = false;
            render();
          } else if (state.contextMenu) {
            state.contextMenu = null;
            render();
          } else if (state.selectedId) {
            state.selectedId = null;
            render();
          }
          return;
        }

        // Delete - Delete selected item
        if (e.key === 'Delete' && state.selectedId && !state.locked) {
          e.preventDefault();
          const selected = getSelected();
          if (selected) {
            deleteItem(selected.id);
          }
          return;
        }

        // Arrow keys - Navigate list
        if ((e.key === 'ArrowDown' || e.key === 'ArrowUp') && !state.locked) {
          e.preventDefault();
          const items = getSortedFiltered();
          if (items.length === 0) return;

          const currentIndex = items.findIndex(i => i.id === state.selectedId);
          let newIndex;

          if (e.key === 'ArrowDown') {
            newIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
          } else {
            newIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
          }

          state.selectedId = items[newIndex].id;
          render();

          // Scroll item into view
          setTimeout(() => {
            const el = document.querySelector(`[data-id="${state.selectedId}"]`);
            el?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 10);
          return;
        }
      }
    });

    // ============ VISIBILITY CHANGE HANDLER ============
    // Refresh TOTP codes when tab becomes visible (fixes stale codes after tab switch)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && !state.locked && state.data.totp?.length > 0) {
        startTotpTimer();
      }
    });

    // Also handle window focus for Electron
    window.addEventListener('focus', () => {
      if (!state.locked && state.data.totp?.length > 0) {
        startTotpTimer();
      }
    });

    // Online/Offline detection
    window.addEventListener('online', () => {
      state.isOnline = true;
      render();
      showSaveIndicator('Back online');
    });

    window.addEventListener('offline', () => {
      state.isOnline = false;
      render();
      showSaveIndicator('You are offline');
    });

    // Lockout timer countdown
    setInterval(() => {
      if (state.locked && state.lockoutUntil > Date.now()) {
        const remaining = Math.ceil((state.lockoutUntil - Date.now()) / 1000);
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;
        const timerEl = document.getElementById('lockoutTimer');
        if (timerEl) {
          const timerDisplay = timerEl.querySelector('div');
          if (timerDisplay) {
            timerDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
          }
        }
      } else if (state.locked && state.lockoutUntil > 0 && state.lockoutUntil <= Date.now()) {
        state.lockoutUntil = 0;
        render();
      }
    }, 1000);
  </script>
</body>
</html>
